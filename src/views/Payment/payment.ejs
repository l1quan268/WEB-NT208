<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thanh to√°n ƒë·∫∑t ph√≤ng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 1200px;
    }
    .form-section {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
    }
    .form-label {
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }
    .form-control {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 12px 15px;
      font-size: 14px;
    }
    .form-control:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    .form-control::placeholder {
      color: #999;
    }
    .order-summary {
      background: white;
      border: 2px solid #dc3545;
      border-radius: 8px;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .order-header {
      background-color: #dc3545;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 16px;
    }
    .order-content {
      padding: 20px;
    }
    .room-info {
      margin-bottom: 20px;
    }
    .room-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }
    .room-dates {
      font-size: 14px;
      color: #666;
      line-height: 1.6;
    }
    .price-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .price-total {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      font-size: 16px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
      margin-top: 10px;
    }
    .payment-methods {
      margin-top: 25px;
    }
    .form-check {
      margin-bottom: 15px;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    .form-check:hover {
      border-color: #007bff;
      background-color: #f8f9ff;
    }
    .form-check-input {
      margin-top: 0.3rem;
    }
    .form-check-input:checked + .form-check-label {
      color: #007bff;
    }
    .form-check-input:checked {
      background-color: #007bff;
      border-color: #007bff;
    }
    .form-check.selected {
      border-color: #007bff !important;
      background-color: #f8f9ff !important;
    }
    .form-check-label {
      font-weight: 500;
      color: #333;
      cursor: pointer;
      width: 100%;
    }
    .payment-description {
      font-size: 13px;
      color: #666;
      margin-top: 10px;
      line-height: 1.4;
    }
    .btn-book {
      background-color: #dc3545;
      border: none;
      color: white;
      font-weight: 600;
      font-size: 16px;
      padding: 15px;
      border-radius: 5px;
      width: 100%;
      margin-top: 20px;
      transition: background-color 0.3s ease;
    }
    .btn-book:hover {
      background-color: #c82333;
    }
    .btn-book:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .required {
      color: #dc3545;
    }
    .additional-info {
      margin-top: 30px;
    }
    .additional-info .section-title {
      font-size: 16px;
      color: #666;
      margin-bottom: 15px;
    }
    .payment-icon {
      width: 20px;
      height: 20px;
      margin-right: 8px;
    }
    .momo-color {
      color: #d82d8b;
    }
    .cash-color {
      color: #28a745;
    }
    /* ‚úÖ NEW: Pricing breakdown styles */
    .pricing-breakdown {
      background-color: #f8f9fa;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #007bff;
    }
    .pricing-breakdown .breakdown-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .pricing-breakdown .breakdown-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 13px;
      color: #666;
    }
    .pricing-breakdown .breakdown-item.highlight {
      color: #dc3545;
      font-weight: 500;
    }
    .guest-info {
      background-color: #e3f2fd;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 13px;
      color: #1976d2;
    }
    /* Debug styles */
    .debug-info {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      max-width: 300px;
      z-index: 9999;
      display: none;
    }
    .debug-info.show {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Debug Info Panel -->
  <div id="debugInfo" class="debug-info">
    <div id="debugContent"></div>
  </div>

  <div class="container my-5">
    <form id="checkoutForm">
      <!-- Hidden fields from backend -->
      <input type="hidden" name="room_id" id="hiddenRoomId" value="<%= room_id %>">
      <input type="hidden" name="checkin" id="hiddenCheckin" value="<%= checkin %>">
      <input type="hidden" name="checkout" id="hiddenCheckout" value="<%= checkout %>">
      <input type="hidden" name="adults" id="hiddenAdults" value="<%= adults %>">
      <input type="hidden" name="children" id="hiddenChildren" value="<%= children %>">

      <div class="row">
        <div class="col-lg-6 col-md-6">
          <div class="form-section">
            <h5 class="section-title">TH√îNG TIN THANH TO√ÅN</h5>

            <div class="mb-3">
              <label for="fullname" class="form-label">H·ªç v√† t√™n <span class="required">*</span></label>
              <input type="text" class="form-control" id="fullname" name="fullname" 
                     value="<%= user?.name || '' %>" required />
            </div>

            <div class="mb-3">
              <label for="address" class="form-label">ƒê·ªãa ch·ªâ <span class="required">*</span></label>
              <input type="text" class="form-control" id="address" name="address" 
                     placeholder="V√≠ d·ª•: S·ªë xx Ng√µ xx Ph√∫ Ki·ªÅu, B·∫Øc T·ª´ Li√™m, H√† N·ªôi" required />
            </div>

            <div class="mb-3">
              <label for="phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
              <input type="tel" class="form-control" id="phone" name="phone" 
                     value="<%= user?.phone || '' %>" required />
            </div>

            <div class="mb-3">
              <label for="email" class="form-label">ƒê·ªãa ch·ªâ email <span class="required">*</span></label>
              <input type="email" class="form-control" id="email" name="email" 
                     value="<%= user?.email || '' %>" required />
            </div>

            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="createAccount" name="createAccount" />
              <label class="form-check-label" for="createAccount">T·∫°o t√†i kho·∫£n m·ªõi?</label>
            </div>

            <div class="additional-info">
              <h6 class="section-title">TH√îNG TIN B·ªî SUNG</h6>
              <div class="mb-3">
                <label for="notes" class="form-label">Ghi ch√∫ ƒë·∫∑t ph√≤ng (tu·ª≥ ch·ªçn)</label>
                <textarea class="form-control" id="notes" name="note" rows="4" 
                          placeholder="Ghi ch√∫ ƒë·∫∑t ph√≤ng: V√≠ d·ª•: T√¥i s·∫Ω ƒë·∫øn kh√°ch s·∫°n v√†o l√∫c chi·ªÅu, T√¥i s·∫µn s√†ng ch·ªù hai ti·∫øng..v.v."></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-6 col-md-6">
          <div class="order-summary">
            <div class="order-header">
              <span>TH√îNG TIN ƒê·∫∂T PH√íNG</span>
              <span>CHI TI·∫æT GI√Å</span>
            </div>

            <div class="order-content">
              <div class="room-info">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="room-name">
                      <strong>Ph√≤ng:</strong><br />
                      <%= room?.type_name || 'Deluxe Room' %> √ó <span id="nightCount"><%= pricing?.nights || 1 %></span> ƒë√™m
                    </div>
                    <div class="room-dates">
                      <div><strong>NG√ÄY NH·∫¨N PH√íNG:</strong> <span id="checkinDisplay"><%= checkin %></span></div>
                      <div><strong>NG√ÄY TR·∫¢ PH√íNG:</strong> <span id="checkoutDisplay"><%= checkout %></span></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ‚úÖ Guest Information -->
              <div class="guest-info">
                <div class="d-flex justify-content-between">
                  <span><i class="fas fa-users me-1"></i> T·ªïng kh√°ch:</span>
                  <span><strong id="totalGuests"><%= (adults + children) %> ng∆∞·ªùi</strong></span>
                </div>
                <div class="d-flex justify-content-between">
                  <span>‚îî Ng∆∞·ªùi l·ªõn:</span>
                  <span id="adultsDisplay"><%= adults %></span>
                </div>
                <div class="d-flex justify-content-between">
                  <span>‚îî Tr·∫ª em:</span>
                  <span id="childrenDisplay"><%= children %></span>
                </div>
                <% if (adults > 5) { %>
                <div class="d-flex justify-content-between text-warning">
                  <span><i class="fas fa-exclamation-triangle me-1"></i> Ph·ª• thu (ng∆∞·ªùi l·ªõn > 5):</span>
                  <span><%= (adults - 5) %> ng∆∞·ªùi l·ªõn</span>
                </div>
                <% } %>
                <% if (children > 0) { %>
                <div class="d-flex justify-content-between text-info">
                  <span><i class="fas fa-child me-1"></i> Tr·∫ª em mi·ªÖn ph·ª• thu</span>
                  <span><i class="fas fa-check text-success"></i></span>
                </div>
                <% } %>
              </div>

              <!-- ‚úÖ Detailed Pricing Breakdown -->
              <div class="pricing-breakdown">
                <div class="breakdown-title">
                  <i class="fas fa-calculator me-1"></i> Chi ti·∫øt t√≠nh gi√°
                </div>
                
                <div class="breakdown-item">
                  <span>Gi√° ph√≤ng/ƒë√™m:</span>
                  <span id="roomPricePerNight"><%= Number(room?.price_per_night || 500000).toLocaleString('vi-VN') %> ‚Ç´</span>
                </div>
                
                <div class="breakdown-item">
                  <span>S·ªë ƒë√™m:</span>
                  <span id="nightsCount"><%= pricing?.nights || 1 %> ƒë√™m</span>
                </div>
                
                <div class="breakdown-item">
                  <span>Th√†nh ti·ªÅn ph√≤ng:</span>
                  <span id="baseAmount"><%= Number(pricing?.baseAmount || 500000).toLocaleString('vi-VN') %> ‚Ç´</span>
                </div>
                
                <% if (pricing && pricing.surchargeAdults > 0) { %>
                <div class="breakdown-item highlight">
                  <span>Ph·ª• thu (<%= pricing.surchargeAdults %> ng∆∞·ªùi l·ªõn √ó <%= pricing.nights %> ƒë√™m):</span>
                  <span id="surchargeAmount">+<%= Number(pricing.totalSurcharge).toLocaleString('vi-VN') %> ‚Ç´</span>
                </div>
                <div class="breakdown-item" style="font-size: 12px; color: #666;">
                  <span>‚îî Ch·ªâ t√≠nh ph·ª• thu cho ng∆∞·ªùi l·ªõn th·ª© 6 tr·ªü l√™n</span>
                  <span></span>
                </div>
                <% } %>
              </div>

              <!-- ‚úÖ Price Summary -->
              <div class="price-row">
                <span>T·∫°m t√≠nh:</span>
                <span id="subtotalAmount"><%= Number(pricing?.totalAmount || 500000).toLocaleString('vi-VN') %> ‚Ç´</span>
              </div>

              <div class="price-total">
                <span>T·ªïng c·ªông:</span>
                <span id="totalAmount"><%= Number(pricing?.totalAmount || 500000).toLocaleString('vi-VN') %> ‚Ç´</span>
              </div>

              <div class="payment-methods">
                <div class="form-check" data-payment="vnpay">
                  <input class="form-check-input" type="radio" name="paymentMethod" id="vnpay" value="vnpay" checked />
                  <label class="form-check-label" for="vnpay">
                    <i class="fas fa-credit-card text-primary payment-icon"></i>
                    <strong>Thanh to√°n online qua VNPay</strong>
                  </label>
                  <div class="payment-description">
                    <div class="row mt-2">
                      <div class="col-12">
                        <small class="text-muted">H·ªó tr·ª£ thanh to√°n b·∫±ng:</small>
                        <div class="d-flex flex-wrap gap-2 mt-1">
                          <span class="badge bg-primary">ATM n·ªôi ƒë·ªãa</span>
                          <span class="badge bg-success">Internet Banking</span>
                          <span class="badge bg-warning">V√≠ ƒëi·ªán t·ª≠</span>
                          <span class="badge bg-info">Th·∫ª qu·ªëc t·∫ø</span>
                        </div>
                        <div class="mt-2">
                          <small class="text-info">
                            <i class="fas fa-shield-alt me-1"></i> B·∫£o m·∫≠t SSL 256-bit | ƒê∆∞·ª£c c·∫•p ph√©p b·ªüi
                            Ng√¢n h√†ng Nh√† n∆∞·ªõc
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-check" data-payment="momo">
                  <input class="form-check-input" type="radio" name="paymentMethod" id="momo" value="momo" />
                  <label class="form-check-label" for="momo">
                    <i class="fas fa-mobile-alt momo-color payment-icon"></i>
                    <strong>Thanh to√°n qua V√≠ MoMo</strong>
                  </label>
                  <div class="payment-description">
                    <div class="row mt-2">
                      <div class="col-12">
                        <small class="text-muted">Thanh to√°n nhanh ch√≥ng v√† an to√†n v·ªõi MoMo:</small>
                        <div class="d-flex flex-wrap gap-2 mt-1">
                          <span class="badge" style="background-color: #d82d8b">V√≠ MoMo</span>
                          <span class="badge bg-success">Li√™n k·∫øt ng√¢n h√†ng</span>
                          <span class="badge bg-info">Th·∫ª t√≠n d·ª•ng</span>
                        </div>
                        <div class="mt-2">
                          <small class="text-info">
                            <i class="fas fa-shield-alt me-1"></i> B·∫£o m·∫≠t ƒëa l·ªõp | Ho√†n ti·ªÅn 100% n·∫øu c√≥ sai s√≥t
                          </small>
                        </div>
                        <div class="mt-1">
                          <small class="text-muted">
                            <i class="fas fa-gift me-1"></i> T√≠ch ƒëi·ªÉm MoMo - Nh·∫≠n ∆∞u ƒë√£i h·∫•p d·∫´n
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-check" data-payment="cash">
                  <input class="form-check-input" type="radio" name="paymentMethod" id="cash" value="cash" />
                  <label class="form-check-label" for="cash">
                    <i class="fas fa-money-bill-wave cash-color payment-icon"></i>
                    <strong>Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t</strong>
                  </label>
                  <div class="payment-description">
                    <div class="row mt-2">
                      <div class="col-12">
                        <small class="text-muted">Thanh to√°n tr·ª±c ti·∫øp t·∫°i kh√°ch s·∫°n:</small>
                        <div class="mt-2">
                          <small class="text-success">
                            <i class="fas fa-check-circle me-1"></i> Thanh to√°n khi nh·∫≠n ph√≤ng
                          </small>
                        </div>
                        <div class="mt-1">
                          <small class="text-success">
                            <i class="fas fa-check-circle me-1"></i> Kh√¥ng ph√≠ giao d·ªãch
                          </small>
                        </div>
                        <div class="mt-1">
                          <small class="text-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i> Vui l√≤ng chu·∫©n b·ªã ƒë·ªß ti·ªÅn m·∫∑t khi check-in
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <button type="submit" class="btn-book" id="bookBtn">ƒê·∫∂T PH√íNG</button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE_URL = "/api";
    const CHECKOUT_ENDPOINT = `${API_BASE_URL}/checkout`;

    // ‚úÖ Get pricing data from server
    const PRICING_DATA = {
      roomPrice: <%= room?.price_per_night || 500000 %>,
      nights: <%= pricing?.nights || 1 %>,
      adults: <%= adults %>,
      children: <%= children %>,
      totalGuests: <%= (adults + children) %>,
      baseAmount: <%= pricing?.baseAmount || 500000 %>,
      surchargePerNight: <%= pricing?.surchargePerNight || 0 %>,
      totalSurcharge: <%= pricing?.totalSurcharge || 0 %>,
      totalAmount: <%= pricing?.totalAmount || 500000 %>
    };

    // Debug log panel
    function debugLog(message, data = null) {
      console.log(`üîç [Payment Debug] ${message}`, data);
      const debugInfo = document.getElementById("debugInfo");
      const debugContent = document.getElementById("debugContent");
      if (debugInfo && debugContent) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.innerHTML = `<strong>${timestamp}</strong>: ${message}`;
        if (data) logEntry.innerHTML += `<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
        debugContent.appendChild(logEntry);
        debugInfo.classList.add("show");
        setTimeout(() => debugInfo.classList.remove("show"), 10000);
      }
    }

    async function testAPIConnectivity() {
      try {
        debugLog("Testing API connectivity...");
        const response = await fetch(`${API_BASE_URL}/health`, { method: "GET", headers: { Accept: "application/json" } });
        if (response.ok) {
          const result = await response.json();
          debugLog("API connectivity test successful", result);
          return true;
        } else {
          debugLog("API connectivity test failed", { status: response.status, statusText: response.statusText, url: response.url });
          return false;
        }
      } catch (error) {
        debugLog("API connectivity test error", error.message);
        return false;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      debugLog("Page loaded successfully");
      debugLog("Pricing data from server", PRICING_DATA);

      const form = document.getElementById("checkoutForm");
      const bookBtn = document.getElementById("bookBtn");

      testAPIConnectivity();

      const paymentOptions = document.querySelectorAll(".form-check[data-payment]");
      const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');

      paymentRadios.forEach((radio) => {
        radio.addEventListener("change", function () {
          paymentOptions.forEach((option) => option.classList.remove("selected"));
          if (this.checked) {
            const selectedOption = document.querySelector(`.form-check[data-payment="${this.value}"]`);
            if (selectedOption) selectedOption.classList.add("selected");
            debugLog("Payment method selected", this.value);
          }
        });
      });

      const checkedRadio = document.querySelector('input[name="paymentMethod"]:checked');
      if (checkedRadio) {
        const initialOption = document.querySelector(`.form-check[data-payment="${checkedRadio.value}"]`);
        if (initialOption) initialOption.classList.add("selected");
      }

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        debugLog("Form submitted");
        if (validateForm()) processBooking();
      });

      function validateForm() {
        const requiredFields = ["fullname", "address", "phone", "email"];
        let isValid = true;

        requiredFields.forEach((fieldName) => {
          const field = document.getElementById(fieldName);
          field.classList.remove("is-invalid", "is-valid");

          if (!field.value.trim()) {
            field.classList.add("is-invalid");
            isValid = false;
          } else {
            if (fieldName === "email" && !isValidEmail(field.value)) {
              field.classList.add("is-invalid");
              isValid = false;
            } else if (fieldName === "phone" && !isValidPhone(field.value)) {
              field.classList.add("is-invalid");
              isValid = false;
            } else {
              field.classList.add("is-valid");
            }
          }
        });

        if (!isValid) {
          alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
          debugLog("Form validation failed");
        } else {
          debugLog("Form validation passed");
        }

        return isValid;
      }

      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      function isValidPhone(phone) {
        const phoneRegex = /^[0-9]{10,11}$/;
        return phoneRegex.test(phone.replace(/\s+/g, ""));
      }

      function processBooking() {
        debugLog("Starting booking process");
        const originalText = bookBtn.innerHTML;
        bookBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang x·ª≠ l√Ω...';
        bookBtn.disabled = true;

        const formData = new FormData(form);
        const bookingData = {};
        for (let [key, value] of formData.entries()) {
          bookingData[key] = value;
        }
        debugLog("Booking data prepared from form", bookingData);
        debugLog("Making request to", CHECKOUT_ENDPOINT);

        fetch(CHECKOUT_ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify(bookingData),
        })
          .then(async (response) => {
            debugLog("Response received", {
              status: response.status,
              statusText: response.statusText,
              ok: response.ok,
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              const text = await response.text();
              debugLog("Non-JSON response received", text.substring(0, 200));
              throw new Error("Server returned non-JSON response: " + text.substring(0, 100));
            }
            return response.json();
          })
          .then((result) => {
            debugLog("Success response received", result);

            if (result.success) {
              handlePaymentSuccess(result);
            } else {
              throw new Error(result.message || "Booking failed");
            }
          })
          .catch((error) => {
            debugLog("Booking error occurred", { message: error.message, stack: error.stack });
            let errorMessage = "C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t ph√≤ng.";
            if (error.message.includes("HTTP error")) {
              errorMessage = "L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.";
            } else if (error.message.includes("non-JSON response")) {
              errorMessage = "Server ƒëang b·∫£o tr√¨. Vui l√≤ng th·ª≠ l·∫°i sau.";
            } else if (error.message.includes("Failed to fetch")) {
              errorMessage = "L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra internet.";
            } else {
              errorMessage = error.message;
            }
            alert(errorMessage);
          })
          .finally(() => {
            bookBtn.innerHTML = originalText;
            bookBtn.disabled = false;
            debugLog("Booking process completed");
          });
      }

      function handlePaymentSuccess(result) {
        const paymentMethod = result.payment_method;
        debugLog("Handling payment success", { paymentMethod, hasRedirectUrl: !!result.redirect_url });

        if (paymentMethod === "vnpay" && result.redirect_url) {
          showVNPayRedirect(result.redirect_url);
        } else if (paymentMethod === "momo" && result.redirect_url) {
          showMoMoRedirect(result.redirect_url);
        } else if (paymentMethod === "cash") {
          showCashPaymentConfirmation(result);
        } else {
          alert("L·ªói: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c th√¥ng tin thanh to√°n");
        }
      }

      function showVNPayRedirect(paymentUrl) {
        showPaymentModal({
          title: "Chuy·ªÉn h∆∞·ªõng ƒë·∫øn VNPay",
          icon: "fas fa-credit-card fa-4x text-primary",
          description: "B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn trang thanh to√°n VNPay trong gi√¢y l√°t...",
          paymentUrl,
        });
      }

      function showMoMoRedirect(paymentUrl) {
        showPaymentModal({
          title: "Chuy·ªÉn h∆∞·ªõng ƒë·∫øn MoMo",
          icon: "fas fa-mobile-alt fa-4x momo-color",
          description: "B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn ·ª©ng d·ª•ng MoMo ƒë·ªÉ thanh to√°n...",
          paymentUrl,
        });
      }

      function showCashPaymentConfirmation(result) {
        debugLog("Showing cash payment confirmation");

        const modal = document.createElement("div");
        modal.className = "modal fade show";
        modal.style.display = "block";
        modal.style.backgroundColor = "rgba(0,0,0,0.8)";
        modal.innerHTML = `
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
              <div class="modal-body text-center py-5">
                <div class="mb-4">
                  <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                  <h4 class="text-success mb-3">ƒê·∫∑t ph√≤ng th√†nh c√¥ng!</h4>
                  <p class="text-muted mb-4">Booking ƒë√£ ƒë∆∞·ª£c t·∫°o. Vui l√≤ng thanh to√°n khi check-in.</p>
                </div>
                
                <div class="row">
                  <div class="col-md-6">
                    <div class="card border-0 bg-light">
                      <div class="card-body">
                        <h6 class="card-title">
                          <i class="fas fa-info-circle me-2 text-primary"></i>
                          Th√¥ng tin ƒë·∫∑t ph√≤ng
                        </h6>
                        <div class="text-start">
                          <p class="mb-1"><strong>M√£ ƒë·∫∑t ph√≤ng:</strong> ${result.order_id}</p>
                          <p class="mb-1"><strong>Kh√°ch h√†ng:</strong> ${result.booking_details?.guest_name || "N/A"}</p>
                          <p class="mb-1"><strong>Lo·∫°i ph√≤ng:</strong> ${result.booking_details?.room_type || "N/A"}</p>
                          <p class="mb-1"><strong>Check-in:</strong> ${result.booking_details?.checkin || "N/A"}</p>
                          <p class="mb-1"><strong>Check-out:</strong> ${result.booking_details?.checkout || "N/A"}</p>
                          <p class="mb-1"><strong>S·ªë ƒë√™m:</strong> ${result.booking_details?.nights || "N/A"}</p>
                          <p class="mb-1"><strong>S·ªë kh√°ch:</strong> ${result.booking_details?.total_guests || "N/A"} ng∆∞·ªùi</p>
                          ${result.booking_details?.total_surcharge > 0 ? 
                            `<p class="mb-1 text-warning"><strong>Ph·ª• thu:</strong> ${Number(result.booking_details?.total_surcharge).toLocaleString('vi-VN')} ‚Ç´</p>` : ''}
                          <p class="mb-0"><strong>T·ªïng ti·ªÅn:</strong> <span class="text-danger">${result.booking_details?.formatted_amount || "N/A"}</span></p>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card border-0 bg-warning bg-opacity-10">
                      <div class="card-body">
                        <h6 class="card-title">
                          <i class="fas fa-money-bill-wave me-2 text-warning"></i>
                          Chi ti·∫øt thanh to√°n
                        </h6>
                        <div class="text-start">
                          ${result.booking_details?.price_breakdown ? `
                            <p class="mb-1 small">Gi√° ph√≤ng: ${Number(result.booking_details.price_breakdown.room_price_per_night).toLocaleString('vi-VN')} ‚Ç´/ƒë√™m</p>
                            <p class="mb-1 small">S·ªë ƒë√™m: ${result.booking_details.price_breakdown.nights}</p>
                            <p class="mb-1 small">Th√†nh ti·ªÅn ph√≤ng: ${Number(result.booking_details.price_breakdown.base_total).toLocaleString('vi-VN')} ‚Ç´</p>
                            ${result.booking_details.price_breakdown.surcharge_adults > 0 ? 
                              `<p class="mb-1 small text-warning">Ph·ª• thu ${result.booking_details.price_breakdown.surcharge_adults} ng∆∞·ªùi l·ªõn: +${Number(result.booking_details.price_breakdown.total_surcharge).toLocaleString('vi-VN')} ‚Ç´</p>
                               <p class="mb-1 small text-muted">‚îî Tr·∫ª em kh√¥ng t√≠nh ph·ª• thu</p>` : ''}
                            <hr class="my-2">
                            <p class="mb-1 small"><strong>T·ªïng c·ªông: ${Number(result.booking_details.price_breakdown.final_total).toLocaleString('vi-VN')} ‚Ç´</strong></p>
                          ` : '<p class="small">Thanh to√°n khi check-in</p>'}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="alert alert-info mt-4">
                  <h6 class="alert-heading">
                    <i class="fas fa-info-circle me-2"></i>
                    H∆∞·ªõng d·∫´n thanh to√°n:
                  </h6>
                  <p class="mb-1 small">1. Vui l√≤ng chu·∫©n b·ªã ƒë·ªß ti·ªÅn m·∫∑t khi check-in</p>
                  <p class="mb-1 small">2. Mang theo CMND/CCCD khi nh·∫≠n ph√≤ng</p>
                  <p class="mb-1 small">3. Check-in t·ª´ 14:00, Check-out tr∆∞·ªõc 12:00</p>
                  <p class="mb-0 small">Hotline h·ªó tr·ª£: <strong>1900-1234</strong></p>
                </div>
                
                <div class="mt-4">
                  <button type="button" class="btn btn-success btn-lg me-3" onclick="window.location.href='/'">
                    <i class="fas fa-home me-2"></i>
                    V·ªÅ trang ch·ªß
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>
                    In phi·∫øu ƒë·∫∑t ph√≤ng
                  </button>
                </div>
              </div>
            </div>
          </div>`;

        document.body.appendChild(modal);
      }

      function showPaymentModal({ title, icon, description, paymentUrl }) {
        const modal = document.createElement("div");
        modal.className = "modal fade show";
        modal.style.display = "block";
        modal.style.backgroundColor = "rgba(0,0,0,0.8)";
        modal.innerHTML = `
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
              <div class="modal-body text-center py-5">
                <div class="mb-4">
                  <div class="mb-3">
                    <i class="${icon}"></i>
                  </div>
                  <h4 class="text-primary mb-3">${title}</h4>
                  <p class="text-muted mb-4">${description}</p>

                  <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%"></div>
                  </div>

                  <div class="d-flex justify-content-center align-items-center mb-3">
                    <div class="spinner-border text-primary me-2" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="text-muted">ƒêang x·ª≠ l√Ω...</span>
                  </div>
                </div>

                <div class="mt-4">
                  <button type="button" class="btn btn-primary btn-lg" onclick="window.location.href='${paymentUrl}'">
                    <i class="fas fa-external-link-alt me-2"></i>
                    Ti·∫øn h√†nh thanh to√°n
                  </button>
                </div>
              </div>
            </div>
          </div>`;

        document.body.appendChild(modal);
        startAutoRedirect(paymentUrl);
      }

      function startAutoRedirect(paymentUrl) {
        let progress = 0;
        const progressBar = document.querySelector(".progress-bar");
        const progressInterval = setInterval(() => {
          progress += 10;
          progressBar.style.width = progress + "%";

          if (progress >= 100) {
            clearInterval(progressInterval);
            setTimeout(() => {
              window.location.href = paymentUrl;
            }, 500);
          }
        }, 200);
      }

      // Enable debug mode if ?debug=1 in URL
      if (window.location.search.includes("debug=1")) {
        document.getElementById("debugInfo").classList.add("show");
      }
    });
  </script>
</body>
</html>