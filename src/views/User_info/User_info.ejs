<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Th√¥ng tin t√†i kho·∫£n</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <link rel="stylesheet" href="/details_homestay.css" />
    <!-- Lightbox CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet" />

    <!-- Lightbox JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<style>
    body {
        background-color: #f8f9fa;
    }

    .suggested-rooms-wrapper {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 0, 10px;
        margin-left: 40px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);

    }

    .suggested-rooms-wrapper a {
        text-decoration: none;
        color: inherit;
    }

    .suggested-rooms-wrapper a:hover {
        text-decoration: underline;
    }

    .suggested-rooms-wrapper {
        background-color: #fff7e6;
        background: #f3e6dc;
        border-radius: 8px;
        /* padding: 20px; */
        margin-left: 40px;
        box-shadow: 10px 10px 15px rgba(202, 131, 131, 0.1);
        opacity: 1;
    }

    /* Ti√™u ƒë·ªÅ cƒÉn gi·ªØa */
    .suggested-rooms-wrapper>h5 {
        text-align: center;
        font-weight: bold;
        margin-bottom: 20px;


    }


    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }

    */
</style>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light" style="
        width: 100%;
        opacity: 80%;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
      ">
        <!-- Logo b√™n tr√°i -->
        <a class="navbar-brand" href="/">
            <img src="/image/image/logo/logo.jpg" alt="Logo" style="
            margin: 0px;
            padding: 0px;
            width: 100px;
            height: 100px;
            position: absolute;
            margin-top: -50px;
            margin-left: 70px;
          " class="logo" />
        </a>
        <div class="container kt">
            <!-- N√∫t Toggle khi m√†n h√¨nh nh·ªè -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Danh m·ª•c menu (CƒÉn gi·ªØa) -->
            <div class="collapse navbar-collapse justify-content-center" id="navbarNav" style="margin-left: 50px">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/" style="font-weight: bold">TRANG CH·ª¶</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#intro" style="font-weight: bold">GI·ªöI THI·ªÜU</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#CH" style="font-weight: bold">CƒÇN H·ªò</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#LH" style="font-weight: bold">LI√äN H·ªÜ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#DG" style="font-weight: bold">ƒê√ÅNH GI√Å</a>
                    </li>
                </ul>
            </div>

            <!-- N√∫t ƒêƒÉng nh·∫≠p/ƒêƒÉng xu·∫•t (B√™n ph·∫£i) -->
            <% if (user) { %>
                <div class="dropdown">
                    <button class="btn p-0 border-0 bg-transparent" type="button" id="userDropdown"
                        data-bs-toggle="dropdown" aria-expanded="false">

                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown">
                        <li><span class="dropdown-item text-primary fw-bold">
                                <p class="fw-bold">
                                    <%= user?.email %>
                                </p>
                            </span></li>
                        <li><a class="dropdown-item" href="/account">Th√¥ng tin t√†i kho·∫£n</a></li>
                        <li><a class="dropdown-item" href="/bookings">L·ªãch s·ª≠ giao d·ªãch</a></li>
                        <li>
                            <hr class="dropdown-divider" />
                        </li>
                        <li><a class="dropdown-item text-danger" href="/logout">ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </div>
                <% } else { %>
                    <button class="btn btn-primary" onclick="window.location.href='/login'"
                        style="background-color: white;">
                        ƒêƒÇNG NH·∫¨P
                    </button>
                    <% } %>
        </div>
    </nav>
    </div>
    <div class="product-info-container container my-5" style="padding-top: 0.5px">
        <div class="container">
            <div class="breadcrumb mt-5 mb-3">
                <a href="/" class="breadcrumb-link">Trang ch·ªß</a> /

                <span class="breadcrumb-current">Th√¥ng tin t√†i kho·∫£n</span>
            </div>

        </div>
        <!-- -->
        <div class="container mt-5 pt-5">
            <div class="row justify-content-center">
                <!-- C·ªôt tr√°i: Avatar + menu -->
                <div class="col-md-3 mb-4">
                    <div class="bg-white p-4 text-center rounded shadow-sm">
                        <img src="https://i.postimg.cc/rF3Fh10Y/avatar-trang-4.jpg" alt="Avatar"
                            class="rounded-circle mb-3" width="120" />
                        <p class="fw-bold">
                            <%= user.email %>
                        </p>
                        <hr />
                        <div class="text-start">
                            <p><a href="#" id="btn-info" class="text-decoration-none fw-bold text-dark"
                                    onclick="showTab('info')">Th√¥ng tin t√†i kho·∫£n</a></p>
                            <p><a href="#" id="btn-password" class="text-decoration-none text-secondary"
                                    onclick="showTab('password')">ƒê·ªïi m·∫≠t kh·∫©u</a></p>
                            <p><a href="#" id="btn-booking" class="text-decoration-none text-secondary"
                                    onclick="showTab('booking')">L·ªãch s·ª≠ giao d·ªãch</a></p>
                            <p><a href="/logout" class="text-danger text-decoration-none">ƒêƒÉng xu·∫•t</a></p>
                        </div>
                    </div>
                </div>

                <!-- C·ªôt ph·∫£i: Form c·∫≠p nh·∫≠t -->

                <div class="col-md-9">
                    <% if (message) { %>
                        <script>
                            Swal.fire({
                                icon: 'success',
                                title: 'Ch√∫c m·ª´ng: ',
                                text: "<%= message %>",
                                timer: 2000,
                                showConfirmButton: false
                            });
                        </script>
                        <% } %>
                            <div id="tab-info">
                                <div class="bg-white p-4 rounded shadow-sm">
                                    <h4 class="mb-4 fw-bold text-center">TH√îNG TIN C√Å NH√ÇN</h4>
                                    <form action="/account/update" method="POST">
                                        <div class="mb-3">
                                            <label class="form-label">H·ªç v√† t√™n</label>
                                            <input name="name" class="form-control" value="<%= userData.name %>" />
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                            <input name="phone" class="form-control" value="<%= userData.phone %>" />
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Ng√†y sinh (mm/dd/yyyy)</label>
                                            <input type="date" name="dob" class="form-control"
                                                value="<%= userData.dobFormatted || '' %>" />
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label d-block">Gi·ªõi t√≠nh</label>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="gender" value="male"
                                                    <%=userData.gender==='male' ? 'checked' : '' %> />
                                                <label class="form-check-label">Nam</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="gender"
                                                    value="female" <%=userData.gender==='female' ? 'checked' : '' %> />
                                                <label class="form-check-label">N·ªØ</label>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <button type="submit" class="btn"
                                                style="background-color: #e5d6c5; color: black;">C·∫≠p nh·∫≠t</button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- C·ªôt ph·∫£i: Form ƒë·ªïi m·∫≠t kh·∫©u -->
                            <div id="tab-password" style="display: none;">
                                <div class="bg-white p-4 rounded shadow-sm">
                                    <h4 class="mb-4 fw-bold text-center">ƒê·ªîI M·∫¨T KH·∫®U</h4>
                                    <form action="/change-password" method="POST" onsubmit="return validatePassword();">
                                        <!-- M·∫≠t kh·∫©u hi·ªán t·∫°i -->
                                        <div class="mb-3 position-relative">
                                            <label class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                                            <input type="password" id="currentPassword" name="currentPassword"
                                                class="form-control" required
                                                oninput="updateTyped('currentPassword')" />
                                            <i class="fas fa-eye toggle-password" data-target="currentPassword"
                                                style="position: absolute; top: 38px; right: 10px; cursor: pointer;"></i>
                                            <div class="form-check mt-2">


                                                <div id="typed_currentPassword" class="mt-1 text-muted small"
                                                    style="display: none;"></div>
                                            </div>
                                        </div>

                                        <!-- M·∫≠t kh·∫©u m·ªõi -->
                                        <div class="mb-3 position-relative">
                                            <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
                                            <input type="password" id="newPassword" name="newPassword"
                                                class="form-control" required oninput="updateTyped('newPassword')" />
                                            <i class="fas fa-eye toggle-password" data-target="newPassword"
                                                style="position: absolute; top: 38px; right: 10px; cursor: pointer;"></i>
                                            <div class="form-check mt-2">


                                                <div id="typed_newPassword" class="mt-1 text-muted small"
                                                    style="display: none;"></div>
                                            </div>
                                        </div>

                                        <!-- X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi -->
                                        <div class="mb-3 position-relative">
                                            <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                                            <input type="password" id="confirmPassword" name="confirmPassword"
                                                class="form-control" required
                                                oninput="updateTyped('confirmPassword')" />
                                            <i class="fas fa-eye toggle-password" data-target="confirmPassword"
                                                style="position: absolute; top: 38px; right: 10px; cursor: pointer;"></i>
                                            <div class="form-check mt-2">


                                                <div id="typed_confirmPassword" class="mt-1 text-muted small"
                                                    style="display: none;"></div>
                                            </div>
                                        </div>

                                        <div class="text-end">
                                            <button type="submit" class="btn"
                                                style="background-color: #e5d6c5; color: black;">X√°c nh·∫≠n</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <!-- Tab: L·ªäCH S·ª¨ ƒê·∫∂T PH√íNG -->
                            <div id="tab-booking" style="display: none;">
                                <div class="bg-white p-4 rounded shadow-sm">
                                    <h4 class="mb-4 fw-bold text-center">L·ªäCH S·ª¨ GIAO D·ªäCH</h4>
                                    <% if (bookings && bookings.length> 0) { %>
                                        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ccc;">
                                            <table class="table table-bordered text-center align-middle"
                                                style="table-layout: fixed; width: 100%;">
                                                <thead class="table-warning"
                                                    style="display: table; width: 100%; table-layout: fixed;">
                                                    <tr>
                                                        <th style="width: 60px; white-space: nowrap;">STT</th>
                                                        <th style="width: 60px; white-space: nowrap;">M√£</th>
                                                        <th style="width: 180px; white-space: nowrap;">H·ªç v√† t√™n</th>
                                                        <th style="width: 120px; white-space: nowrap;">Ng√†y ƒë·∫∑t</th>
                                                        <th style="width: 160px; white-space: nowrap;">Ph√≤ng</th>
                                                        <th style="width: 120px; white-space: nowrap;">Ng√†y ƒë·∫øn</th>
                                                        <th style="width: 120px; white-space: nowrap;">Ng√†y ƒëi</th>
                                                        <th style="width: 100px; white-space: nowrap;">L·ªõn/Nh·ªè</th>
                                                        <th style="width: 160px; white-space: nowrap;">Gi√°</th>
                                                        <th style="width: 100px; white-space: nowrap;">Tr·∫°ng th√°i</th>
                                                        <th style="width: 160px; white-space: nowrap;">T√πy ch·ªçn</th>
                                                    </tr>
                                                </thead>
                                                <tbody style="display: block; width: 100%;">
                                                    <% bookings.forEach((b, index)=> { %>
                                                        <tr style="display: table; table-layout: fixed; width: 100%;">
                                                            <td style="width: 60px">
                                                                <%= index + 1 %>
                                                            </td>
                                                            <td style="width: 60px">
                                                                <%= b.booking_id %>
                                                            </td>
                                                            <td style="width: 180px">
                                                                <%= b.name %>
                                                            </td>
                                                            <td style="width: 120px">
                                                                <%= new Date(b.booking_date).toLocaleDateString("vi-VN")
                                                                    %>
                                                            </td>
                                                            <td style="width: 160px">
                                                                <%= b.room_name %>
                                                            </td>
                                                            <td style="width: 120px">
                                                                <%= new
                                                                    Date(b.check_in_date).toLocaleDateString("vi-VN") %>
                                                            </td>
                                                            <td style="width: 120px">
                                                                <%= new
                                                                    Date(b.check_out_date).toLocaleDateString("vi-VN")
                                                                    %>
                                                            </td>
                                                            <td style="width: 100px">
                                                                <%= b.adults %> / <%= b.children %>
                                                            </td>
                                                            <td style="width: 160px">
                                                                <%= Number(b.total_price).toLocaleString("vi-VN")
                                                                    + " vnƒë" %>
                                                            </td>
                                                            <td style="width: 100px"
                                                                class="<%= b.payment_status === 'paid' ? 'text-success' : (b.payment_status === 'failed' ? 'text-danger' : 'text-warning') %> fw-bold">
                                                                    <%= b.payment_status === 'paid' ? 'ƒê√£ tr·∫£' : (b.payment_status === 'failed' ? 'ƒê√£ h·ªßy' : 'Ch∆∞a tr·∫£') %>
                                                            </td>
                                                            <td style="width: 160px" class="text-nowrap">
                                                                <div
                                                                    class="d-flex justify-content-center gap-2 flex-wrap">
                                                                    <% if (b.payment_status !== 'paid' && b.payment_status !== 'failed') { %>
                                                                        <form id="cancel-form-<%= index %>"
                                                                            action="/booking/cancel" method="POST">
                                                                            <input type="hidden" name="booking_id"
                                                                                value="<%= b.booking_id %>">
                                                                            <button type="button"
                                                                                class="btn btn-danger btn-sm"
                                                                                onclick="confirmCancel(<%= index %>)">
                                                                                H·ªßy ƒë∆°n
                                                                            </button>
                                                                        </form>
                                                                        
                                                                        <!-- ‚úÖ FORM THANH TO√ÅN ƒê∆Ø·ª¢C S·ª¨A -->
                                                                        <form id="payment-form-<%= index %>" action="/api/checkout" method="POST">
                                                                            <!-- ‚úÖ DEBUG: Hi·ªÉn th·ªã th√¥ng tin ƒë·ªÉ ki·ªÉm tra -->
                                                                            <input type="hidden" name="debug_info" value="booking_id:<%= b.booking_id %>,room_type_id:<%= b.room_type_id %>,name:<%= b.name %>">
                                                                            
                                                                            <!-- ‚úÖ S·ª¨A: ƒê·∫£m b·∫£o room_id c√≥ gi√° tr·ªã -->
                                                                            <input type="hidden" name="room_id" value="<%= b.room_type_id || b.room_id || '1' %>">
                                                                            
                                                                            <!-- ‚úÖ S·ª¨A: Format ng√†y ƒë√∫ng v√† ki·ªÉm tra null -->
                                                                            <input type="hidden" name="checkin" value="<%= b.check_in_date ? new Date(b.check_in_date).toISOString().split('T')[0] : '2024-12-20' %>">
                                                                            <input type="hidden" name="checkout" value="<%= b.check_out_date ? new Date(b.check_out_date).toISOString().split('T')[0] : '2024-12-21' %>">
                                                                            
                                                                            <!-- ‚úÖ S·ª¨A: ƒê·∫£m b·∫£o adults/children c√≥ gi√° tr·ªã -->
                                                                            <input type="hidden" name="adults" value="<%= b.adults || '1' %>">
                                                                            <input type="hidden" name="children" value="<%= b.children || '0' %>">
                                                                            
                                                                            <!-- ‚úÖ S·ª¨A: ƒê·∫£m b·∫£o fullname c√≥ gi√° tr·ªã -->
                                                                            <input type="hidden" name="fullname" value="<%= b.name || 'Kh√°ch h√†ng' %>">
                                                                            
                                                                            <!-- ‚úÖ S·ª¨A: ƒê·∫£m b·∫£o email v√† phone c√≥ gi√° tr·ªã -->
                                                                            <input type="hidden" name="email" value="<%= b.guest_email || user.email || 'customer@example.com' %>">
                                                                            <input type="hidden" name="phone" value="<%= b.guest_phone || user.phone || '0123456789' %>">
                                                                            
                                                                            <!-- ‚úÖ S·ª¨A: ƒê·∫£m b·∫£o address c√≥ gi√° tr·ªã -->
                                                                            <input type="hidden" name="address" value="<%= b.guest_address || user.address || 'ƒê·ªãa ch·ªâ kh√°ch h√†ng' %>">
                                                                            
                                                                            <!-- ‚úÖ TH√äM: Tr∆∞·ªùng note -->
                                                                            <input type="hidden" name="note" value="Thanh to√°n t·ª´ l·ªãch s·ª≠ giao d·ªãch - Booking ID: <%= b.booking_id %>">
                                                                            
                                                                            <input type="hidden" name="paymentMethod" value="vnpay">
                                                                            <input type="hidden" name="existing_booking_id" value="<%= b.booking_id %>">
                                                                            
                                                                            <button type="button" class="btn btn-success btn-sm" onclick="processVNPayPayment(<%= index %>)">
                                                                                Thanh to√°n
                                                                            </button>
                                                                        </form>

                                                                        <!-- ‚úÖ DEBUG: Script ƒë·ªÉ log th√¥ng tin booking -->
                                                                        <script>
                                                                            console.log('üîç Booking <%= index %> Debug Info:', {
                                                                                booking_id: '<%= b.booking_id %>',
                                                                                room_type_id: '<%= b.room_type_id %>',
                                                                                room_id: '<%= b.room_id %>',
                                                                                name: '<%= b.name %>',
                                                                                check_in_date: '<%= b.check_in_date %>',
                                                                                check_out_date: '<%= b.check_out_date %>',
                                                                                adults: '<%= b.adults %>',
                                                                                children: '<%= b.children %>',
                                                                                guest_email: '<%= b.guest_email %>',
                                                                                guest_phone: '<%= b.guest_phone %>',
                                                                                guest_address: '<%= b.guest_address %>'
                                                                            });
                                                                        </script>
                                                                        
                                                                        <% } else { %>
                                                                            <span class="text-muted">Kh√¥ng kh·∫£
                                                                                d·ª•ng</span>
                                                                            <% } %>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <% }) %>
                                                </tbody>
                                            </table>
                                        </div>
                                        <% } else { %>
                                            <p class="text-center text-muted">Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o.</p>
                                            <% } %>
                                </div>
                            </div>

                </div>
            </div>

        </div>
    </div>

    <br><br><br><br><br>
    <footer class="bg-light py-4" style="width: 100%" id="LH" style="margin-left: 0">
        <div class="container" style="margin-top: 20px">
            <div class="row">
                <!-- C·ªôt Li√™n H·ªá -->
                <div class="col-md-4">
                    <h5 class="fw-bold">LI√äN H·ªÜ CH√öNG T√îI</h5>

                    <p>
                        <i class="fas fa-envelope" style="color: #9d972d"></i> Email: 23521265@gm.uit.edu.vn
                    </p>
                    <p><i class="fas fa-phone" style="color: #28a745"></i></i> S·ªë ƒëi·ªán tho·∫°i: 080-678-963-210
                    </p>
                    <p>
                        <i class="fas fa-map-marker-alt" style="color: #dc3545"></i> ƒê·ªãa ch·ªâ: 183B/19, qu·∫≠n Cam,
                        th√†nh ph·ªë S√†i G√≤n
                    </p>
                </div>

                <!-- C·ªôt M·∫°ng X√£ H·ªôi -->
                <div class="col-md-4 text-left">
                    <h5 class="fw-bold">M·∫†NG X√É H·ªòI</h5>
                    <a href="https://www.instagram.com" target="_blank"
                        class="d-block text-decoration-none text-dark mb-2">
                        <i class="fab fa-instagram" style="
                  background: linear-gradient(
                    to right,
                    #f09433 0%,
                    #e6683c 25%,
                    #dc2743 50%,
                    #cc2366 75%,
                    #bc1888 100%
                  );
                  -webkit-background-clip: text;
                  -webkit-text-fill-color: transparent;
                "></i> Instagram
                    </a>
                    <a href="https://www.facebook.com" target="_blank"
                        class="d-block text-decoration-none text-dark mb-2">
                        <i class="fab fa-facebook" style="color: #1877f2"></i> Facebook
                    </a>
                    <a href="https://www.youtube.com" target="_blank"
                        class="d-block text-decoration-none text-dark mb-2">
                        <i class="fab fa-youtube" style="color: #ff0000"></i> Youtube
                    </a>
                    <a href="https://www.twitter.com" target="_blank"
                        class="d-block text-decoration-none text-dark mb-2">
                        <i class="fab fa-twitter" style="color: #000000"></i> Twitter
                    </a>
                </div>

                <!-- C·ªôt B·∫£n ƒê·ªì -->
                <div class="col-md-4">
                    <h5 class="fw-bold">MAPS</h5>
                    <iframe src="https://www.google.com/maps?q=V≈©ng+T√†u&output=embed" width="100%" height="150"
                        style="border: 0" allowfullscreen="" loading="lazy">
                    </iframe>
                </div>
            </div>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ‚úÖ ENHANCED VNPAY PAYMENT FUNCTION WITH DEBUG
        function processVNPayPayment(index) {
            // ‚úÖ TH√äM: Debug form data tr∆∞·ªõc khi validate
            const form = document.getElementById(`payment-form-${index}`);
            const formData = new FormData(form);
            
            console.log('üîç RAW FORM DATA:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: "${value}"`);
            }
            
            Swal.fire({
                title: 'X√°c nh·∫≠n thanh to√°n',
                text: "B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn h∆∞·ªõng ƒë·∫øn VNPay ƒë·ªÉ thanh to√°n. Ti·∫øp t·ª•c?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Thanh to√°n VNPay',
                cancelButtonText: 'H·ªßy',
            }).then((result) => {
                if (result.isConfirmed) {
                    // Hi·ªÉn th·ªã loading
                    Swal.fire({
                        title: 'ƒêang x·ª≠ l√Ω...',
                        text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // ‚úÖ S·ª¨A: T·∫°o object v√† validate t·ª´ng tr∆∞·ªùng v·ªõi fallback
                    const paymentData = {
                        room_id: formData.get('room_id') || '1',
                        checkin: formData.get('checkin') || '2024-12-20',
                        checkout: formData.get('checkout') || '2024-12-21',
                        adults: formData.get('adults') || '1',
                        children: formData.get('children') || '0',
                        fullname: formData.get('fullname') || 'Kh√°ch h√†ng',
                        email: formData.get('email') || 'customer@example.com',
                        phone: formData.get('phone') || '0123456789',
                        address: formData.get('address') || 'ƒê·ªãa ch·ªâ kh√°ch h√†ng',
                        paymentMethod: 'vnpay',
                        note: formData.get('note') || 'Thanh to√°n t·ª´ l·ªãch s·ª≠ giao d·ªãch',
                        existing_booking_id: formData.get('existing_booking_id') || ''
                    };

                    // ‚úÖ TH√äM: Validate v√† clean d·ªØ li·ªáu
                    console.log('üîß CLEANED PAYMENT DATA:');
                    Object.entries(paymentData).forEach(([key, value]) => {
                        // Trim whitespace cho string values
                        if (typeof value === 'string') {
                            paymentData[key] = value.trim();
                        }
                        console.log(`  ${key}: "${paymentData[key]}"`);
                    });

                    // ‚úÖ TH√äM: Validate required fields v·ªõi th√¥ng b√°o c·ª• th·ªÉ
                    const requiredFields = ['room_id', 'checkin', 'checkout', 'fullname', 'email', 'phone', 'address'];
                    const missingFields = [];
                    const emptyFields = [];
                    
                    requiredFields.forEach(field => {
                        const value = paymentData[field];
                        if (!value) {
                            missingFields.push(field);
                        } else if (typeof value === 'string' && value.trim() === '') {
                            emptyFields.push(field);
                        }
                    });
                    
                    if (missingFields.length > 0 || emptyFields.length > 0) {
                        Swal.close();
                        
                        let errorMessage = 'L·ªói d·ªØ li·ªáu form:\n';
                        if (missingFields.length > 0) {
                            errorMessage += `‚Ä¢ Thi·∫øu: ${missingFields.join(', ')}\n`;
                        }
                        if (emptyFields.length > 0) {
                            errorMessage += `‚Ä¢ Tr·ªëng: ${emptyFields.join(', ')}\n`;
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Thi·∫øu th√¥ng tin',
                            text: errorMessage,
                            footer: '<small>Vui l√≤ng ki·ªÉm tra console (F12) ƒë·ªÉ xem chi ti·∫øt</small>'
                        });
                        return;
                    }

                    // ‚úÖ TH√äM: Validate ƒë·ªãnh d·∫°ng email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(paymentData.email)) {
                        Swal.close();
                        Swal.fire({
                            icon: 'error',
                            title: 'Email kh√¥ng h·ª£p l·ªá',
                            text: `Email "${paymentData.email}" kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng`
                        });
                        return;
                    }

                    // ‚úÖ TH√äM: Validate s·ªë ƒëi·ªán tho·∫°i
                    const phoneRegex = /^[0-9]{10,11}$/;
                    if (!phoneRegex.test(paymentData.phone.replace(/\s+/g, ''))) {
                        Swal.close();
                        Swal.fire({
                            icon: 'error',
                            title: 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá',
                            text: `S·ªë ƒëi·ªán tho·∫°i "${paymentData.phone}" ph·∫£i c√≥ 10-11 ch·ªØ s·ªë`
                        });
                        return;
                    }

                    // ‚úÖ TH√äM: Validate room_id l√† s·ªë
                    if (isNaN(parseInt(paymentData.room_id))) {
                        Swal.close();
                        Swal.fire({
                            icon: 'error',
                            title: 'Room ID kh√¥ng h·ª£p l·ªá',
                            text: `Room ID "${paymentData.room_id}" ph·∫£i l√† s·ªë`
                        });
                        return;
                    }

                    console.log('‚úÖ FINAL PAYMENT DATA (validated):', paymentData);

                    fetch('/api/checkout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(paymentData)
                    })
                    .then(async response => {
                        console.log('üì° Response status:', response.status);
                        console.log('üì° Response headers:', Object.fromEntries(response.headers.entries()));
                        
                        if (!response.ok) {
                            let errorData;
                            try {
                                errorData = await response.json();
                                console.error('‚ùå Error response JSON:', errorData);
                            } catch (e) {
                                const errorText = await response.text();
                                console.error('‚ùå Error response text:', errorText);
                                errorData = { message: errorText };
                            }
                            throw new Error(errorData.message || `HTTP ${response.status}`);
                        }
                        
                        const contentType = response.headers.get("content-type");
                        if (!contentType || !contentType.includes("application/json")) {
                            const text = await response.text();
                            console.error('‚ùå Non-JSON response:', text);
                            throw new Error("Server returned non-JSON response: " + text.substring(0, 100));
                        }
                        
                        return response.json();
                    })
                    .then(data => {
                        console.log('‚úÖ Payment response:', data);
                        Swal.close();
                        
                        if (data.success && data.payment_method === 'vnpay' && data.redirect_url) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Chuy·ªÉn h∆∞·ªõng ƒë·∫øn VNPay',
                                text: 'B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn trang thanh to√°n VNPay',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                console.log('üåê Redirecting to:', data.redirect_url);
                                window.location.href = data.redirect_url;
                            });
                        } else if (data.success && data.payment_method === 'cash') {
                            Swal.fire({
                                icon: 'warning',
                                title: 'VNPay kh√¥ng kh·∫£ d·ª•ng',
                                text: 'H·ªá th·ªëng ƒë√£ chuy·ªÉn v·ªÅ thanh to√°n ti·ªÅn m·∫∑t. B·∫°n c√≥ th·ªÉ thanh to√°n khi check-in.',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.reload();
                            });
                        } else {
                            throw new Error(data.message || 'Kh√¥ng th·ªÉ t·∫°o link thanh to√°n VNPay');
                        }
                    })
                    .catch(error => {
                        Swal.close();
                        console.error('üí• Payment error:', error);
                        
                        let errorMessage = 'C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω thanh to√°n';
                        if (error.message.includes('Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc')) {
                            errorMessage = 'Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc. Vui l√≤ng ki·ªÉm tra l·∫°i d·ªØ li·ªáu booking.';
                        } else if (error.message.includes('400')) {
                            errorMessage = 'Th√¥ng tin thanh to√°n kh√¥ng h·ª£p l·ªá: ' + error.message;
                        } else if (error.message.includes('404')) {
                            errorMessage = 'Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·∫∑t ph√≤ng';
                        } else if (error.message.includes('500')) {
                            errorMessage = 'L·ªói h·ªá th·ªëng, vui l√≤ng th·ª≠ l·∫°i sau';
                        } else if (error.message.includes('Failed to fetch')) {
                            errorMessage = 'L·ªói k·∫øt n·ªëi m·∫°ng, vui l√≤ng ki·ªÉm tra internet';
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói thanh to√°n',
                            text: errorMessage,
                            footer: '<small>Chi ti·∫øt l·ªói: ' + error.message + '</small>'
                        });
                    });
                }
            });
        }

        function confirmCancel(index) {
            Swal.fire({
                title: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn?',
                text: "B·∫°n mu·ªën h·ªßy h√≥a ƒë∆°n n√†y?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'C√≥, h·ªßy ngay!',
                cancelButtonText: 'Kh√¥ng',
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById(`cancel-form-${index}`).submit();
                }
            });
        }

        function updateTyped(id) {
            const value = document.getElementById(id).value;
            document.getElementById("typed_" + id).innerText = value;
        }

        function toggleTyped(id) {
            const checkbox = document.getElementById("showTyped_" + id);
            const typedDiv = document.getElementById("typed_" + id);
            if (checkbox.checked) {
                typedDiv.style.display = "block";
                updateTyped(id);
            } else {
                typedDiv.style.display = "none";
            }
        }

        // üëÅ Toggle password visibility
        document.querySelectorAll(".toggle-password").forEach((icon) => {
            icon.addEventListener("click", function () {
                const input = document.getElementById(this.dataset.target);
                if (input.type === "password") {
                    input.type = "text";
                    this.classList.replace("fa-eye", "fa-eye-slash");
                } else {
                    input.type = "password";
                    this.classList.replace("fa-eye-slash", "fa-eye");
                }
            });
        });

        function showTab(tab) {
            const infoTab = document.getElementById("tab-info");
            const passwordTab = document.getElementById("tab-password");
            const bookingTab = document.getElementById("tab-booking");

            const btnInfo = document.getElementById("btn-info");
            const btnPassword = document.getElementById("btn-password");
            const btnBooking = document.getElementById("btn-booking");

            // ·∫®n h·∫øt
            infoTab.style.display = "none";
            passwordTab.style.display = "none";
            bookingTab.style.display = "none";

            // Reset style
            btnInfo.className = "text-decoration-none text-secondary";
            btnPassword.className = "text-decoration-none text-secondary";
            btnBooking.className = "text-decoration-none text-secondary";

            if (tab === "info") {
                infoTab.style.display = "block";
                btnInfo.className = "text-decoration-none fw-bold text-dark";
            } else if (tab === "password") {
                passwordTab.style.display = "block";
                btnPassword.className = "text-decoration-none fw-bold text-dark";
            } else if (tab === "booking") {
                bookingTab.style.display = "block";
                btnBooking.className = "text-decoration-none fw-bold text-dark";
            }
        }

        // ‚úÖ Ki·ªÉm tra x√°c nh·∫≠n m·∫≠t kh·∫©u
        function validatePassword() {
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword = document.getElementById("confirmPassword").value;
            if (newPassword !== confirmPassword) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Error',
                    text: 'M·∫≠t kh·∫©u v√† x√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp.',
                    timer: 2000,
                    showConfirmButton: false
                });
                return false;
            }
            return true;
        }
    </script>

</body>
</html>