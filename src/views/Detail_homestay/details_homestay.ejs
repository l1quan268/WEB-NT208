<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>
    <%= room?.type_name %> - Chi ti·∫øt ph√≤ng
  </title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
  <link rel="stylesheet" href="/details_homestay.css" />
  <!-- Lightbox CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet" />

  <!-- Lightbox JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<style>
  .suggested-rooms-wrapper {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 0, 10px;
    margin-left: 40px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);

  }

  .suggested-rooms-wrapper a {
    text-decoration: none;
    color: inherit;
  }

  .suggested-rooms-wrapper a:hover {
    text-decoration: underline;
  }

  .suggested-rooms-wrapper {
    background-color: #fff7e6;
    background: #f3e6dc;
    border-radius: 8px;
    /* padding: 20px; */
    margin-left: 40px;
    box-shadow: 10px 10px 15px rgba(202, 131, 131, 0.1);
    opacity: 1;
  }

  /* Ti√™u ƒë·ªÅ cƒÉn gi·ªØa */
  .suggested-rooms-wrapper>h5 {
    text-align: center;
    font-weight: bold;
    margin-bottom: 20px;


  }


  .btn-primary {
    background-color: #007bff;
    border-color: #007bff;
  }

  */
</style>

<body>
  <!-- Gi·ªØ nguy√™n ph·∫ßn navbar c·ªßa b·∫°n -->
  <!-- Navbar -->
  <script>
    const isLoggedIn = <%= user ? 'true' : 'false' %>;
  </script>
  <nav class="navbar navbar-expand-lg navbar-light bg-light" style="
        width: 100%;
        opacity: 80%;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
      ">
    <!-- Logo b√™n tr√°i -->
    <a class="navbar-brand" href="/">
      <img src="/image/image/logo/logo.jpg" alt="Logo" style="
            margin: 0px;
            padding: 0px;
            width: 100px;
            height: 100px;
            position: absolute;
            margin-top: -50px;
            margin-left: 70px;
          " class="logo" />
    </a>
    <div class="container kt">
      <!-- N√∫t Toggle khi m√†n h√¨nh nh·ªè -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Danh m·ª•c menu (CƒÉn gi·ªØa) -->
      <div class="collapse navbar-collapse justify-content-center" id="navbarNav" style="margin-left: 50px">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/" style="font-weight: bold">TRANG CH·ª¶</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/#intro" style="font-weight: bold">GI·ªöI THI·ªÜU</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/#CH" style="font-weight: bold">CƒÇN H·ªò</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#LH" style="font-weight: bold">LI√äN H·ªÜ</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/danh-gia" style="font-weight: bold">ƒê√ÅNH GI√Å</a>
          </li>
        </ul>
      </div>

      <!-- N√∫t ƒêƒÉng nh·∫≠p/ƒêƒÉng xu·∫•t (B√™n ph·∫£i) -->
      <% if (user) { %>
        <div class="dropdown">
          <button class="btn p-0 border-0 bg-transparent" type="button" id="userDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            <img src="https://i.postimg.cc/rF3Fh10Y/avatar-trang-4.jpg" alt="Avatar" class="rounded-circle" width="40"
              height="40" />
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown">
            <li>
              <span class="dropdown-item text-primary fw-bold">
                <%= user.email %>
              </span>
            </li>
            <li>
              <a class="dropdown-item" href="/account">Th√¥ng tin t√†i kho·∫£n</a>
            </li>
            <li>
              <a class="dropdown-item" href="/bookings">L·ªãch s·ª≠ ƒë·∫∑t ph√≤ng</a>
            </li>
            <li>
              <hr class="dropdown-divider" />
            </li>
            <li>
              <a class="dropdown-item text-danger" href="/logout">ƒêƒÉng xu·∫•t</a>
            </li>
          </ul>
        </div>
        <% } else { %>
          <button class="btn btn-primary" onclick="window.location.href='/login'" style="background-color: white;">
            ƒêƒÇNG NH·∫¨P
          </button>
          <% } %>
    </div>
  </nav>

  <div class="product-info-container container my-5" style="padding-top: 0.5px">
    <div class="container">
      <div class="breadcrumb mt-5 mb-3">
        <a href="/" class="breadcrumb-link">Trang ch·ªß</a> /
        <a href="/#CH" class="breadcrumb-link">CƒÉn h·ªô</a> /
        <span class="breadcrumb-current">
          <%= room?.type_name || "Chi ti·∫øt ph√≤ng" %>
        </span>
      </div>

    </div>

    <!-- B·ªë c·ª•c ngang: ·∫£nh ch√≠nh + khung gi√° ph√≤ng -->
    <div class="row align-items-start mb-6">
      <div class="col-md-8">
        <div class="image-gallery">
          <% if (images && images.length> 0) { %>
            <div class="main-image mb-3">
              <a href="<%= images[0].image_url %>" data-lightbox="homestay-gallery" data-title="·∫¢nh ch√≠nh">
                <img src="<%= images[0].image_url %>" alt="·∫¢nh ch√≠nh" class="img-fluid rounded" />
              </a>
            </div>
            <div class="thumbnail-images d-flex flex-wrap gap-2">
              <% images.slice(1).forEach((img, index)=> { %>
                <a href="<%= img.image_url %>" data-lightbox="homestay-gallery" data-title="·∫¢nh <%= index + 1 %>">
                  <img src="<%= img.image_url %>" alt="·∫¢nh ph·ª•" class="img-thumbnail" width="100" />
                </a>
                <% }) %>
            </div>
            <% } %>
        </div>

        <div class="room-info-container mt-4 p-3 rounded shadow-sm bg-white">
          <ul class="list-unstyled room-summary mb-4">
            <li><strong>ƒê·ªãa ch·ªâ:</strong>
              <%= homestay?.address %>
            </li>
            <li><strong>Ph√≤ng ng·ªß:</strong>
              <%= room.bedroom_count %>
            </li>
            <li><strong>Ph√≤ng t·∫Øm:</strong>
              <%= room.toilet_count %>
            </li>
            <li>
              <strong>S·ª©c ch·ª©a:</strong> T·ªëi ƒëa <%= room.max_guests %> ng∆∞·ªùi
            </li>
          </ul>

          <p class="room-description mb-4">
            <%= room.description %>
          </p>

          <h4>Ti·ªán nghi:</h4>
          <ul class="amenities list-unstyled mb-4">
            <% services.forEach(s=> { %>
              <li>
                <i class="fas fa-check-circle text-success me-2"></i>
                <%= s.service_name %>
              </li>
              <% }) %>
          </ul>

          <!-- ----------------------------------- -->


          <!-- ƒê√°nh gi√° homestay -->
          <div style="background-color: #f8f9fa; border-radius: 8px; padding: 20px; margin: 20px 0;">
            <h5 class="mb-3">ƒê√°nh gi√° homestay</h5>

            <!-- Form ƒë√°nh gi√° -->
            <form id="reviewForm" data-room-id="<%= room?.room_type_id %>">
              <div class="mb-3">
                <label class="form-label">Ch·ªçn s·ªë sao:</label>
                <div class="star-rating" id="starRating">
                  <i class="fas fa-star" data-value="1"
                    style="font-size: 1.2rem; color: #ddd; cursor: pointer; transition: color 0.2s;"></i>
                  <i class="fas fa-star" data-value="2"
                    style="font-size: 1.2rem; color: #ddd; cursor: pointer; transition: color 0.2s;"></i>
                  <i class="fas fa-star" data-value="3"
                    style="font-size: 1.2rem; color: #ddd; cursor: pointer; transition: color 0.2s;"></i>
                  <i class="fas fa-star" data-value="4"
                    style="font-size: 1.2rem; color: #ddd; cursor: pointer; transition: color 0.2s;"></i>
                  <i class="fas fa-star" data-value="5"
                    style="font-size: 1.2rem; color: #ddd; cursor: pointer; transition: color 0.2s;"></i>
                </div>
              </div>

              <div class="mb-3">
                <textarea class="form-control" id="commentBox" rows="4" placeholder="Nh·∫≠p b√¨nh lu·∫≠n..."
                  style="resize: none;"></textarea>
              </div>

              <button type="submit" class="btn btn-primary">
                G·ª≠i ƒë√°nh gi√°
              </button>
            </form>

            <!-- Danh s√°ch ƒë√°nh gi√° -->
            <div id="reviewList" class="mt-4">
              <% if (reviews && reviews.length> 0) { %>
                <% reviews.forEach(r=> { %>
                  <div style="border-top: 1px solid #dee2e6; padding-top: 15px; margin-top: 15px;">
                    <div class="d-flex align-items-center mb-2">
                      <img src="https://i.postimg.cc/N0kXMjb5/avatarreview.jpg" class="rounded-circle me-2" width="40"
                        height="40" />
                      <strong>
                        <%= r.User?.name || "·∫®n danh" %>
                      </strong>
                    </div>
                    <div class="mb-1" style="color: #ffc107;">
                      <% for (let i=1; i <=5; i++) { %>
                        <% if (i <=r.rating) { %>
                          <i class="fas fa-star"></i>
                          <% } else { %>
                            <i class="far fa-star"></i>
                            <% } %>
                              <% } %>
                    </div>
                    <p class="mb-1">
                      <%= r.comment %>
                    </p>
                    <small class="text-muted">ƒêƒÉng ng√†y: <%= new Date(r.created_at).toLocaleDateString('vi-VN') %>
                    </small>
                  </div>
                  <% }) %>
                    <% } else { %>
                      <p class="text-muted">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>
                      <% } %>
            </div>
          </div>

        </div>
      </div>
      <!-- --------------------------------------------- -->
      <div class="col-md-4 mt-5 mt-md-0">
        <div class="price-table"
          style="background-color: #f3e6dc; padding: 20px; border-radius: 8px; margin-left: 40px;">
          <h4>
            Gi√° ph√≤ng: <%= Number(room.price_per_night).toLocaleString('vi-VN') %> ƒë / ƒë√™m
          </h4>
          <div class="booking-form mt-3">
            <div class="form-group mb-2">
              <label for="adults">S·ªë ng∆∞·ªùi l·ªõn:</label>
              <input type="number" id="adults" class="form-control" name="adults" value="1" min="1" max="<%= room.max_adults %>" required />
            </div>
            <div class="form-group mb-2">
              <label for="children">S·ªë tr·∫ª em:</label>
              <input type="number" id="children" class="form-control" name="children" value="0" min="0" max="<%= room.max_children %>" />
            </div>
            <div class="form-group mb-2">
              <label for="checkin">Ng√†y nh·∫≠n:</label>
              <input type="date" id="checkin" class="form-control" />
            </div>
            <div class="form-group mb-2">
              <label for="checkout">Ng√†y ƒëi:</label>
              <input type="date" id="checkout" class="form-control" />
            </div>

            <!-- ‚úÖ Updated form v·ªõi adults v√† children -->
            <form action="/payment" method="GET" id="bookingForm">
              <input type="hidden" name="room_id" value="<%= room.room_type_id %>" />
              <input type="hidden" name="checkin" id="hiddenCheckin" />
              <input type="hidden" name="checkout" id="hiddenCheckout" />
              <input type="hidden" name="adults" id="hiddenAdults" />
              <input type="hidden" name="children" id="hiddenChildren" />
              <button type="submit" class="btn btn-dark w-100 mt-2">ƒê·∫∑t ngay</button>
            </form>
          </div>
        </div>
        <% const suggRooms=(typeof suggestedRooms !=='undefined' && Array.isArray(suggestedRooms) &&
          suggestedRooms.length> 0)
          ? suggestedRooms.map(room => {
          let thumb = room.thumbnail || 'https://via.placeholder.com/150';

          // N·∫øu thumbnail kh√¥ng b·∫Øt ƒë·∫ßu b·∫±ng http ho·∫∑c / th√¨ th√™m ti·ªÅn t·ªë /uploads/
          if (!thumb.startsWith('http') && !thumb.startsWith('/')) {
          thumb = '/uploads/' + thumb;
          }

          return {
          ...room,
          thumbnail: thumb,
          price_per_night: room.price_per_night || (Math.floor(Math.random() * 500000) + 200000)
          };
          })
          : [
          { room_type_id: 1, type_name: "Ph√≤ng m·∫´u 1", price_per_night: 300000, thumbnail:
          "https://via.placeholder.com/150" },
          { room_type_id: 2, type_name: "Ph√≤ng m·∫´u 2", price_per_night: 450000, thumbnail:
          "https://via.placeholder.com/150" },
          { room_type_id: 3, type_name: "Ph√≤ng m·∫´u 3", price_per_night: 500000, thumbnail:
          "https://via.placeholder.com/150" }
          ];
          %>

          <div class="container mt-5">
            <div class="suggested-rooms-wrapper p-4 rounded shadow-sm ">
              <h5 class="mb-4">G·ª£i √Ω c√°c ph√≤ng kh√°c </h5>
              <div class="d-flex gap-4 flex-wrap justify-content-center">
                <% suggRooms.forEach(function(sroom) { %>
                  <div class="card" style="width: 18rem; cursor: pointer;">
                    <a href="/room/<%= sroom.slug %>">
                      <img src="<%= sroom.thumbnail %>" class="card-img-top" alt="<%= sroom.type_name %>"
                        style="height: 140px; object-fit: cover;" />
                    </a>
                    <div class="card-body p-3">
                      <h6 class="card-title">
                        <%= sroom.type_name %>
                      </h6>
                      <p class="card-text" style="font-size: 0.95rem; color: #444;">
                        Gi√°: <%= Number(sroom.price_per_night).toLocaleString('vi-VN') %> ƒë/ƒë√™m
                      </p>
                    </div>
                  </div>
                  <% }) %>
              </div>
            </div>

          </div>

      </div>

      <!-- ----------------------------------- -->
    </div>
    <!-- ƒê√≥ng row -->
  </div>
  <!-- ƒê√≥ng product-info-container -->

  <!-- Footer -->
  <footer class="bg-light py-4" style="width: 100%" id="LH" style="margin-left: 0">
    <div class="container" style="margin-top: 20px">
      <div class="row">
        <!-- C·ªôt Li√™n H·ªá -->
        <div class="col-md-4">
          <h5 class="fw-bold">LI√äN H·ªÜ CH√öNG T√îI</h5>

          <p>
            <i class="fas fa-envelope" style="color: #9d972d"></i> Email: 23521265@gm.uit.edu.vn
          </p>
          <p><i class="fas fa-phone" style="color: #28a745"></i></i> S·ªë ƒëi·ªán tho·∫°i: 080-678-963-210</p>
          <p>
            <i class="fas fa-map-marker-alt" style="color: #dc3545"></i> ƒê·ªãa ch·ªâ: 183B/19, qu·∫≠n Cam,
            th√†nh ph·ªë S√†i G√≤n
          </p>
        </div>

        <!-- C·ªôt M·∫°ng X√£ H·ªôi -->
        <div class="col-md-4 text-left">
          <h5 class="fw-bold">M·∫†NG X√É H·ªòI</h5>
          <a href="https://www.instagram.com" target="_blank" class="d-block text-decoration-none text-dark mb-2">
            <i class="fab fa-instagram" style="
                  background: linear-gradient(
                    to right,
                    #f09433 0%,
                    #e6683c 25%,
                    #dc2743 50%,
                    #cc2366 75%,
                    #bc1888 100%
                  );
                  -webkit-background-clip: text;
                  -webkit-text-fill-color: transparent;
                "></i> Instagram
          </a>
          <a href="https://www.facebook.com" target="_blank" class="d-block text-decoration-none text-dark mb-2">
            <i class="fab fa-facebook" style="color: #1877f2"></i> Facebook
          </a>
          <a href="https://www.youtube.com" target="_blank" class="d-block text-decoration-none text-dark mb-2">
            <i class="fab fa-youtube" style="color: #ff0000"></i> Youtube
          </a>
          <a href="https://www.twitter.com" target="_blank" class="d-block text-decoration-none text-dark mb-2">
            <i class="fab fa-twitter" style="color: #000000"></i> Twitter
          </a>
        </div>

        <!-- C·ªôt B·∫£n ƒê·ªì -->
        <div class="col-md-4">
          <h5 class="fw-bold">MAPS</h5>
          <iframe src="https://www.google.com/maps?q=V≈©ng+T√†u&output=embed" width="100%" height="150" style="border: 0"
            allowfullscreen="" loading="lazy">
          </iframe>
        </div>
      </div>
    </div>
  </footer>
  <script>
  document.getElementById('bookingForm').addEventListener('submit', function (e) {
    if (!isLoggedIn) {
      e.preventDefault();
      Swal.fire({
        icon: 'info',
        title: 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p',
        text: 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c ƒë·∫∑t ph√≤ng!',
        confirmButtonText: 'ƒêƒÉng nh·∫≠p'
      }).then(() => {
        window.location.href = '/login';
      });
      return false;
    }
  });
</script>

  <div class="text-center mt-3">
    <p class="mb-0">¬© 2025 - All Rights Reserved</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ----------------------------------- -->
  <!-- script cho ƒë√°nh gi√°  -->
<script>
  // üî• TH√äM BI·∫æN GLOBAL CHO CALENDAR
  let bookedDates = [];
  const roomId = '<%= room.room_type_id %>';

  // üî• LOAD BOOKED DATES KHI TRANG T·∫¢I
  document.addEventListener('DOMContentLoaded', function () {
    loadBookedDates();
    updateStars();
    setupFormHandlers();
  });

  // üî• FUNCTION LOAD NG√ÄY ƒê√É ƒê·∫∂T T·ª™ SERVER
  function loadBookedDates() {
    // T·∫°o API endpoint gi·∫£ (b·∫°n c·∫ßn t·∫°o API n√†y)
    fetch(`/api/room/${roomId}/booked-dates`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          bookedDates = data.bookedDates || [];
          console.log('üìÖ Loaded booked dates:', bookedDates);
          setupDateValidation();
        } else {
          console.warn('Could not load booked dates, using empty array');
          bookedDates = [];
          setupDateValidation();
        }
      })
      .catch(error => {
        console.warn('Error loading booked dates:', error);
        // Fallback: hardcode m·ªôt s·ªë ng√†y ƒë·ªÉ test
        bookedDates = [
          '2025-06-15',
          '2025-06-16', 
          '2025-06-20',
          '2025-06-21',
          '2025-06-25'
        ];
        setupDateValidation();
      });
  }

  //--------------------------------
  // BOOKING CONFLICT PREVENTION SYSTEM
// Thay th·∫ø to√†n b·ªô script date validation b·∫±ng code n√†y

document.addEventListener('DOMContentLoaded', function() {
  let confirmedBookings = []; // C√°c booking ƒë√£ thanh to√°n
  const roomId = '<%= room.room_type_id %>';
  
  // Load confirmed bookings khi trang t·∫£i
  loadConfirmedBookings();
  
  function loadConfirmedBookings() {
    // API call ƒë·ªÉ l·∫•y c√°c booking ƒë√£ confirm/thanh to√°n cho ph√≤ng n√†y
    fetch(`/api/room/${roomId}/confirmed-bookings`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          confirmedBookings = data.bookings || [];
        } else {
          // Fallback data ƒë·ªÉ test (gi·∫£ s·ª≠ c√≥ ng∆∞·ªùi ƒë·∫∑t t·ª´ 14-18/06)
          confirmedBookings = [
            {
              id: 1,
              checkin: '2025-06-14',
              checkout: '2025-06-18',
              guest_name: 'Nguyen Van A',
              status: 'confirmed'
            },
            {
              id: 2, 
              checkin: '2025-06-20',
              checkout: '2025-06-23',
              guest_name: 'Tran Thi B',
              status: 'confirmed'
            },
            {
              id: 3,
              checkin: '2025-06-25',
              checkout: '2025-06-28',
              guest_name: 'Le Van C', 
              status: 'confirmed'
            }
          ];
        }
        console.log('üìÖ Loaded confirmed bookings:', confirmedBookings);
        setupConflictPrevention();
        displayBookingCalendar();
      })
      .catch(error => {
        console.warn('Error loading bookings:', error);
        // Fallback data ƒë·ªÉ test
        confirmedBookings = [
          {
            id: 1,
            checkin: '2025-06-14',
            checkout: '2025-06-18',
            guest_name: 'Kh√°ch h√†ng A',
            status: 'confirmed'
          }
        ];
        setupConflictPrevention();
        displayBookingCalendar();
      });
  }
  
  function setupConflictPrevention() {
    const checkinInput = document.getElementById("checkin");
    const checkoutInput = document.getElementById("checkout");
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    checkinInput.min = today;
    checkoutInput.min = today;
    
    // Add custom CSS
    addConflictPreventionStyles();
    
    // Setup event listeners
    checkinInput.addEventListener('change', handleCheckinSelection);
    checkoutInput.addEventListener('change', handleCheckoutSelection);
    
    // Add visual indicators
    setupVisualIndicators();
  }
  
  function addConflictPreventionStyles() {
    const style = document.createElement('style');
    style.textContent = `
      .conflict-warning {
        background-color: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        animation: conflictPulse 0.5s ease-in-out;
      }
      
      .conflict-error {
        background-color: #f8d7da;
        border: 2px solid #dc3545;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        animation: conflictShake 0.5s ease-in-out;
      }
      
      .booking-timeline {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #007bff;
      }
      
      .booked-period {
        background: linear-gradient(90deg, #dc3545 0%, #dc3545 100%);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.85rem;
        margin: 3px;
        display: inline-block;
        position: relative;
      }
      
      .available-period {
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.85rem;
        margin: 3px;
        display: inline-block;
      }
      
      .date-input-conflict {
        border: 2px solid #dc3545 !important;
        box-shadow: 0 0 10px rgba(220,53,69,0.4) !important;
        animation: conflictBorder 0.5s ease-in-out infinite alternate;
      }
      
      .date-input-success {
        border: 2px solid #28a745 !important;
        box-shadow: 0 0 10px rgba(40,167,69,0.3) !important;
      }
      
      @keyframes conflictPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
      }
      
      @keyframes conflictShake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
      }
      
      @keyframes conflictBorder {
        0% { border-color: #dc3545; }
        100% { border-color: #ff6b7a; }
      }
      
      .suggestion-box {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        border: 1px solid #bbdefb;
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
      }
      
      .suggested-date {
        background: #4caf50;
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-block;
        font-weight: 500;
      }
      
      .suggested-date:hover {
        background: #45a049;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
    `;
    document.head.appendChild(style);
  }
  
  function handleCheckinSelection() {
    const checkinInput = document.getElementById("checkin");
    const checkoutInput = document.getElementById("checkout");
    const selectedDate = checkinInput.value;
    
    // Reset styling
    checkinInput.classList.remove('date-input-conflict', 'date-input-success');
    clearConflictMessages();
    
    if (!selectedDate) return;
    
    // Ki·ªÉm tra xem ng√†y checkin c√≥ b·ªã conflict kh√¥ng
    const conflictBooking = findConflictingBooking(selectedDate, selectedDate);
    
    if (conflictBooking) {
      // Ng√†y checkin b·ªã tr√πng v·ªõi booking ƒë√£ c√≥
      checkinInput.classList.add('date-input-conflict');
      showConflictError(conflictBooking, 'checkin');
      checkinInput.value = ''; // Clear invalid date
      return;
    }
    
    // Ng√†y checkin OK, check available checkout range
    checkinInput.classList.add('date-input-success');
    
    // Update checkout minimum
    const nextDay = new Date(selectedDate);
    nextDay.setDate(nextDay.getDate() + 1);
    checkoutInput.min = nextDay.toISOString().split('T')[0];
    
    // Clear checkout if it's invalid
    if (checkoutInput.value && checkoutInput.value <= selectedDate) {
      checkoutInput.value = '';
    }
    
    // Show available checkout suggestions
    showCheckoutSuggestions(selectedDate);
  }
  
  function handleCheckoutSelection() {
    const checkinInput = document.getElementById("checkin");
    const checkoutInput = document.getElementById("checkout");
    const checkinDate = checkinInput.value;
    const checkoutDate = checkoutInput.value;
    
    // Reset styling
    checkoutInput.classList.remove('date-input-conflict', 'date-input-success');
    clearConflictMessages();
    
    if (!checkoutDate) return;
    
    if (!checkinDate) {
      showError('Vui l√≤ng ch·ªçn ng√†y nh·∫≠n ph√≤ng tr∆∞·ªõc!');
      checkoutInput.value = '';
      return;
    }
    
    if (checkoutDate <= checkinDate) {
      showError('Ng√†y tr·∫£ ph√≤ng ph·∫£i sau ng√†y nh·∫≠n ph√≤ng!');
      checkoutInput.value = '';
      return;
    }
    
    // Ki·ªÉm tra to√†n b·ªô range c√≥ conflict kh√¥ng
    const conflictBooking = findConflictingBooking(checkinDate, checkoutDate);
    
    if (conflictBooking) {
      checkoutInput.classList.add('date-input-conflict');
      showConflictError(conflictBooking, 'range', checkinDate, checkoutDate);
      checkoutInput.value = '';
      return;
    }
    
    // Range OK
    checkoutInput.classList.add('date-input-success');
    showSuccessMessage(checkinDate, checkoutDate);
  }
  
  function findConflictingBooking(startDate, endDate) {
    for (let booking of confirmedBookings) {
      // Ki·ªÉm tra overlap: 
      // Booking m·ªõi: [startDate, endDate)
      // Booking c≈©: [booking.checkin, booking.checkout)
      
      if (startDate < booking.checkout && endDate > booking.checkin) {
        return booking;
      }
    }
    return null;
  }
  
  function showConflictError(conflictBooking, type, userCheckin = null, userCheckout = null) {
    const container = document.querySelector('.booking-form');
    
    let message = '';
    let suggestionHtml = '';
    
    if (type === 'checkin') {
      message = `
        <div class="conflict-error">
          <h6><i class="fas fa-exclamation-triangle me-2"></i>Ng√†y kh√¥ng kh·∫£ d·ª•ng!</h6>
          <p><strong>Ng√†y ${formatDate(conflictBooking.checkin)}</strong> ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t trong kho·∫£ng:</p>
          <div class="booked-period">
            üìÖ ${formatDate(conflictBooking.checkin)} ‚Üí ${formatDate(conflictBooking.checkout)}
          </div>
          <p style="margin-top: 10px; color: #721c24;">
            <i class="fas fa-info-circle me-1"></i>
            Vui l√≤ng ch·ªçn ng√†y kh√°c ƒë·ªÉ tr√°nh tr√πng l·∫∑p v·ªõi kh√°ch h√†ng ƒë√£ ƒë·∫∑t.
          </p>
        </div>
      `;
      
      suggestionHtml = generateCheckinSuggestions();
      
    } else if (type === 'range') {
      const conflictStart = new Date(Math.max(new Date(userCheckin), new Date(conflictBooking.checkin)));
      const conflictEnd = new Date(Math.min(new Date(userCheckout), new Date(conflictBooking.checkout)));
      
      message = `
        <div class="conflict-error">
          <h6><i class="fas fa-exclamation-triangle me-2"></i>Kho·∫£ng th·ªùi gian b·ªã tr√πng!</h6>
          <p>Th·ªùi gian b·∫°n ch·ªçn <strong>${formatDate(userCheckin)} ‚Üí ${formatDate(userCheckout)}</strong></p>
          <p>B·ªã tr√πng v·ªõi booking ƒë√£ c√≥: <strong>${formatDate(conflictBooking.checkin)} ‚Üí ${formatDate(conflictBooking.checkout)}</strong></p>
          
          <div style="margin: 10px 0; padding: 10px; background: #fff; border-radius: 5px;">
            <div style="color: #dc3545; font-weight: bold;">‚ùå Th·ªùi gian tr√πng: ${formatDate(conflictStart.toISOString().split('T')[0])} ‚Üí ${formatDate(conflictEnd.toISOString().split('T')[0])}</div>
          </div>
          
          <p style="color: #721c24;">
            <i class="fas fa-lightbulb me-1"></i>
            Vui l√≤ng ch·ªçn th·ªùi gian kh√°c ƒë·ªÉ tr√°nh xung ƒë·ªôt.
          </p>
        </div>
      `;
      
      suggestionHtml = generateRangeSuggestions(userCheckin);
    }
    
    const alertDiv = document.createElement('div');
    alertDiv.className = 'conflict-alert';
    alertDiv.innerHTML = message + suggestionHtml;
    
    container.appendChild(alertDiv);
    
    // Auto scroll to conflict message
    alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  
  function generateCheckinSuggestions() {
    const availableDates = findNextAvailableDates(5);
    
    if (availableDates.length === 0) {
      return `
        <div class="suggestion-box">
          <h6><i class="fas fa-calendar-alt me-2"></i>Kh√¥ng c√≥ ng√†y tr·ªëng g·∫ßn ƒë√¢y</h6>
          <p>Vui l√≤ng li√™n h·ªá ƒë·ªÉ ƒë∆∞·ª£c t∆∞ v·∫•n th√™m v·ªÅ l·ªãch tr·ªëng.</p>
        </div>
      `;
    }
    
    let html = `
      <div class="suggestion-box">
        <h6><i class="fas fa-magic me-2"></i>G·ª£i √Ω ng√†y nh·∫≠n ph√≤ng kh·∫£ d·ª•ng:</h6>
        <div style="margin-top: 10px;">
    `;
    
    availableDates.forEach(date => {
      html += `
        <span class="suggested-date" onclick="selectSuggestedDate('${date}', 'checkin')">
          ${formatDate(date)}
        </span>
      `;
    });
    
    html += `
        </div>
        <small style="color: #6c757d; margin-top: 10px; display: block;">
          <i class="fas fa-click me-1"></i>Click v√†o ng√†y ƒë·ªÉ ch·ªçn nhanh
        </small>
      </div>
    `;
    
    return html;
  }
  
  function generateRangeSuggestions(originalCheckin) {
    const suggestions = [];
    
    // Suggestion 1: Checkout tr∆∞·ªõc conflict
    const nearestConflict = findNearestConflictAfter(originalCheckin);
    if (nearestConflict) {
      suggestions.push({
        checkin: originalCheckin,
        checkout: nearestConflict.checkin,
        reason: 'K·∫øt th√∫c tr∆∞·ªõc booking ƒë√£ c√≥'
      });
    }
    
    // Suggestion 2: Start after conflict ends  
    if (nearestConflict) {
      const nextAvailable = findNextAvailableAfter(nearestConflict.checkout);
      if (nextAvailable) {
        suggestions.push({
          checkin: nearestConflict.checkout,
          checkout: nextAvailable,
          reason: 'B·∫Øt ƒë·∫ßu sau booking ƒë√£ c√≥'
        });
      }
    }
    
    // Suggestion 3: Completely different dates
    const alternateDates = findAlternateDateRanges(3);
    suggestions.push(...alternateDates);
    
    let html = `
      <div class="suggestion-box">
        <h6><i class="fas fa-lightbulb me-2"></i>ƒê·ªÅ xu·∫•t th·ªùi gian thay th·∫ø:</h6>
    `;
    
    suggestions.slice(0, 3).forEach((suggestion, index) => {
      const nights = Math.ceil((new Date(suggestion.checkout) - new Date(suggestion.checkin)) / (1000 * 60 * 60 * 24));
      html += `
        <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 5px; border: 1px solid #e0e0e0;">
          <div style="font-weight: bold; color: #2196f3;">L·ª±a ch·ªçn ${index + 1}: ${suggestion.reason}</div>
          <div style="margin: 5px 0;">
            <span class="suggested-date" onclick="selectSuggestedRange('${suggestion.checkin}', '${suggestion.checkout}')">
              ${formatDate(suggestion.checkin)} ‚Üí ${formatDate(suggestion.checkout)} (${nights} ƒë√™m)
            </span>
          </div>
        </div>
      `;
    });
    
    html += `</div>`;
    return html;
  }
  
  function findNextAvailableDates(count) {
    const available = [];
    const today = new Date();
    
    for (let i = 0; i < 60 && available.length < count; i++) {
      const checkDate = new Date(today);
      checkDate.setDate(today.getDate() + i);
      const dateStr = checkDate.toISOString().split('T')[0];
      
      if (!findConflictingBooking(dateStr, dateStr)) {
        available.push(dateStr);
      }
    }
    
    return available;
  }
  
  function findNearestConflictAfter(date) {
    return confirmedBookings
      .filter(booking => booking.checkin > date)
      .sort((a, b) => new Date(a.checkin) - new Date(b.checkin))[0];
  }
  
  function findNextAvailableAfter(date) {
    const checkDate = new Date(date);
    checkDate.setDate(checkDate.getDate() + 1);
    
    for (let i = 0; i < 30; i++) {
      const testDate = new Date(checkDate);
      testDate.setDate(checkDate.getDate() + i);
      const dateStr = testDate.toISOString().split('T')[0];
      
      if (!findConflictingBooking(dateStr, dateStr)) {
        const endDate = new Date(testDate);
        endDate.setDate(testDate.getDate() + 2); // 2 nights minimum
        return endDate.toISOString().split('T')[0];
      }
    }
    return null;
  }
  
  function findAlternateDateRanges(count) {
    const ranges = [];
    const today = new Date();
    
    for (let i = 1; i < 60 && ranges.length < count; i += 7) {
      const startDate = new Date(today);
      startDate.setDate(today.getDate() + i);
      const endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + 3); // 3 nights
      
      const startStr = startDate.toISOString().split('T')[0];
      const endStr = endDate.toISOString().split('T')[0];
      
      if (!findConflictingBooking(startStr, endStr)) {
        ranges.push({
          checkin: startStr,
          checkout: endStr,
          reason: `Tu·∫ßn ${Math.floor(i/7) + 1} t·ªõi`
        });
      }
    }
    
    return ranges;
  }
  
  function showCheckoutSuggestions(checkinDate) {
    const container = document.querySelector('.booking-form');
    const maxStay = findMaximumStayDuration(checkinDate);
    
    const suggestionsHtml = `
      <div class="booking-timeline">
        <h6><i class="fas fa-calendar-check me-2"></i>Th·ªùi gian ·ªü t·ªëi ƒëa t·ª´ ng√†y n√†y:</h6>
        <p>T·ª´ <strong>${formatDate(checkinDate)}</strong>, b·∫°n c√≥ th·ªÉ ·ªü t·ªëi ƒëa <strong>${maxStay} ƒë√™m</strong></p>
        
        <div style="margin-top: 10px;">
          <span class="available-period">‚úÖ C√≥ th·ªÉ ƒë·∫∑t ƒë·∫øn ${formatDate(getDateAfter(checkinDate, maxStay))}</span>
        </div>
        
        ${generateQuickCheckoutOptions(checkinDate, maxStay)}
      </div>
    `;
    
    const alertDiv = document.createElement('div');
    alertDiv.className = 'conflict-alert';
    alertDiv.innerHTML = suggestionsHtml;
    container.appendChild(alertDiv);
  }
  
  function generateQuickCheckoutOptions(checkinDate, maxStay) {
    const options = [1, 2, 3, 7].filter(nights => nights <= maxStay);
    
    let html = `
      <div style="margin-top: 15px;">
        <small style="color: #6c757d;">Ch·ªçn nhanh s·ªë ƒë√™m:</small><br>
    `;
    
    options.forEach(nights => {
      const checkoutDate = getDateAfter(checkinDate, nights);
      html += `
        <span class="suggested-date" onclick="selectSuggestedRange('${checkinDate}', '${checkoutDate}')">
          ${nights} ƒë√™m ‚Üí ${formatDate(checkoutDate)}
        </span>
      `;
    });
    
    html += `</div>`;
    return html;
  }
  
  function findMaximumStayDuration(checkinDate) {
    const nextConflict = findNearestConflictAfter(checkinDate);
    
    if (!nextConflict) {
      return 30; // Maximum 30 nights if no conflicts
    }
    
    const daysDiff = Math.ceil((new Date(nextConflict.checkin) - new Date(checkinDate)) / (1000 * 60 * 60 * 24));
    return Math.max(1, daysDiff);
  }
  
  function showSuccessMessage(checkinDate, checkoutDate) {
    const container = document.querySelector('.booking-form');
    const nights = Math.ceil((new Date(checkoutDate) - new Date(checkinDate)) / (1000 * 60 * 60 * 24));
    
    const successHtml = `
      <div style="background: #d4edda; border: 2px solid #28a745; border-radius: 8px; padding: 15px; margin: 10px 0;">
        <h6 style="color: #155724; margin-bottom: 10px;">
          <i class="fas fa-check-circle me-2"></i>Tuy·ªát v·ªùi! Th·ªùi gian n√†y c√≥ s·∫µn
        </h6>
        <div style="color: #155724;">
          <strong>üìÖ ${formatDate(checkinDate)} ‚Üí ${formatDate(checkoutDate)}</strong> (${nights} ƒë√™m)
        </div>
        <div style="margin-top: 10px; color: #0f5132;">
          <i class="fas fa-info-circle me-1"></i>
          B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c ƒë·∫∑t ph√≤ng v·ªõi th·ªùi gian n√†y.
        </div>
      </div>
    `;
    
    const alertDiv = document.createElement('div');
    alertDiv.className = 'conflict-alert';
    alertDiv.innerHTML = successHtml;
    container.appendChild(alertDiv);
  }
  
  function showError(message) {
    Swal.fire({
      icon: 'warning',
      title: 'L·ªói nh·∫≠p li·ªáu',
      text: message,
      timer: 2500,
      showConfirmButton: false
    });
  }
  
  function clearConflictMessages() {
    const alerts = document.querySelectorAll('.conflict-alert');
    alerts.forEach(alert => alert.remove());
  }
  
  function displayBookingCalendar() {
    const priceTable = document.querySelector('.price-table');
    if (!priceTable) return;
    
    let calendarHtml = `
      <div class="booking-timeline mt-3">
        <h6><i class="fas fa-calendar-alt me-2"></i>L·ªãch ƒë·∫∑t ph√≤ng hi·ªán t·∫°i</h6>
    `;
    
    if (confirmedBookings.length === 0) {
      calendarHtml += `
        <div class="available-period" style="width: 100%; text-align: center; padding: 15px;">
          üéâ Ph√≤ng hi·ªán t·∫°i ho√†n to√†n tr·ªëng! B·∫°n c√≥ th·ªÉ ƒë·∫∑t b·∫•t k·ª≥ ng√†y n√†o.
        </div>
      `;
    } else {
      confirmedBookings
        .filter(booking => new Date(booking.checkout) >= new Date())
        .sort((a, b) => new Date(a.checkin) - new Date(b.checkin))
        .forEach(booking => {
          const nights = Math.ceil((new Date(booking.checkout) - new Date(booking.checkin)) / (1000 * 60 * 60 * 24));
          calendarHtml += `
            <div style="margin: 8px 0;">
              <div class="booked-period">
                üîí ${formatDate(booking.checkin)} ‚Üí ${formatDate(booking.checkout)} (${nights} ƒë√™m)
              </div>
            </div>
          `;
        });
      
      calendarHtml += `
        <small style="color: #6c757d; margin-top: 10px; display: block;">
          <i class="fas fa-info-circle me-1"></i>
          Nh·ªØng ng√†y t√¥ ƒë·ªè ƒë√£ c√≥ kh√°ch ƒë·∫∑t v√† thanh to√°n
        </small>
      `;
    }
    
    calendarHtml += `</div>`;
    
    const calendarDiv = document.createElement('div');
    calendarDiv.innerHTML = calendarHtml;
    priceTable.appendChild(calendarDiv);
  }
  
  // Helper functions
  function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('vi-VN');
  }
  
  function getDateAfter(dateStr, days) {
    const date = new Date(dateStr);
    date.setDate(date.getDate() + days);
    return date.toISOString().split('T')[0];
  }
  
  // Global functions for onclick handlers
  window.selectSuggestedDate = function(date, type) {
    const input = document.getElementById(type);
    input.value = date;
    input.dispatchEvent(new Event('change'));
    clearConflictMessages();
  }
  
  window.selectSuggestedRange = function(checkin, checkout) {
    document.getElementById('checkin').value = checkin;
    document.getElementById('checkout').value = checkout;
    clearConflictMessages();
    showSuccessMessage(checkin, checkout);
  }
});

// Th√™m v√†o cu·ªëi script booking conflict prevention 
// Enhanced booking form validation v·ªõi API integration

// Enhance booking form submission v·ªõi real-time validation
document.addEventListener('DOMContentLoaded', function() {
  const bookingForm = document.getElementById('bookingForm');
  
  // Override form submission
  bookingForm.addEventListener('submit', async function(e) {
    e.preventDefault(); // Always prevent default ƒë·ªÉ ki·ªÉm tra tr∆∞·ªõc
    
    // Get form data
    const checkin = document.getElementById('checkin').value;
    const checkout = document.getElementById('checkout').value;
    const adults = parseInt(document.getElementById('adults').value) || 1;
    const children = parseInt(document.getElementById('children').value) || 0;
    const roomId = '<%= room.room_type_id %>';
    
    // Basic validation
    if (!checkin || !checkout) {
      Swal.fire({
        icon: 'warning',
        title: 'Thi·∫øu th√¥ng tin',
        text: 'Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y nh·∫≠n v√† ng√†y tr·∫£ ph√≤ng.',
        timer: 3000,
        showConfirmButton: false
      });
      return;
    }
    
    // Guest count validation
    const maxAdults = <%= room.max_adults %>;
    const maxChildren = <%= room.max_children %>;
    const maxGuests = <%= room.max_guests %>;
    
    if (adults > maxAdults || children > maxChildren || (adults + children) > maxGuests) {
      Swal.fire({
        icon: 'error',
        title: 'S·ªë l∆∞·ª£ng kh√°ch kh√¥ng h·ª£p l·ªá',
        text: `V∆∞·ª£t qu√° s·ª©c ch·ª©a ph√≤ng (t·ªëi ƒëa ${maxGuests} ng∆∞·ªùi: ${maxAdults} ng∆∞·ªùi l·ªõn, ${maxChildren} tr·∫ª em).`,
        timer: 4000,
        showConfirmButton: false
      });
      return;
    }
    
    // Login check
    if (!isLoggedIn) {
      Swal.fire({
        icon: 'info',
        title: 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p',
        text: 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c ƒë·∫∑t ph√≤ng!',
        confirmButtonText: 'ƒêƒÉng nh·∫≠p',
        showCancelButton: true,
        cancelButtonText: 'H·ªßy'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = '/login';
        }
      });
      return;
    }
    
    // Show loading
    Swal.fire({
      title: 'ƒêang ki·ªÉm tra t√¨nh tr·∫°ng ph√≤ng...',
      text: 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });
    
    try {
      // Final availability check via API
      const availabilityResponse = await fetch(`/api/room/${roomId}/check-availability`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          checkin: checkin,
          checkout: checkout
        })
      });
      
      const availabilityData = await availabilityResponse.json();
      
      if (!availabilityData.success || !availabilityData.available) {
        // Room not available
        Swal.close();
        
        let conflictMessage = 'Ph√≤ng kh√¥ng kh·∫£ d·ª•ng trong th·ªùi gian b·∫°n ch·ªçn.';
        
        if (availabilityData.conflicts && availabilityData.conflicts.length > 0) {
          const conflict = availabilityData.conflicts[0];
          conflictMessage = `
            Th·ªùi gian b·∫°n ch·ªçn (${formatDate(checkin)} - ${formatDate(checkout)}) 
            b·ªã tr√πng v·ªõi booking ƒë√£ c√≥ (${formatDate(conflict.checkin)} - ${formatDate(conflict.checkout)}).
            
            Vui l√≤ng ch·ªçn ng√†y kh√°c.
          `;
        }
        
        await Swal.fire({
          icon: 'error',
          title: 'Ph√≤ng kh√¥ng kh·∫£ d·ª•ng',
          text: conflictMessage,
          confirmButtonText: 'Ch·ªçn ng√†y kh√°c',
          timer: 5000
        });
        
        // Refresh booking data and show suggestions
        await loadConfirmedBookings();
        showAlternativeSuggestions(checkin, checkout);
        return;
      }
      
      // Room is available - proceed with booking
      Swal.close();
      
      await Swal.fire({
        icon: 'success',
        title: 'Ph√≤ng c√≥ s·∫µn!',
        text: 'ƒêang chuy·ªÉn ƒë·∫øn trang thanh to√°n...',
        timer: 1500,
        showConfirmButton: false
      });
      
      // Set hidden form values and submit
      document.getElementById('hiddenCheckin').value = checkin;
      document.getElementById('hiddenCheckout').value = checkout;
      document.getElementById('hiddenAdults').value = adults;
      document.getElementById('hiddenChildren').value = children;
      
      // Submit form programmatically
      bookingForm.submit();
      
    } catch (error) {
      console.error('Error checking availability:', error);
      
      Swal.close();
      
      Swal.fire({
        icon: 'error',
        title: 'L·ªói h·ªá th·ªëng',
        text: 'C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra t√¨nh tr·∫°ng ph√≤ng. Vui l√≤ng th·ª≠ l·∫°i.',
        confirmButtonText: 'Th·ª≠ l·∫°i',
        timer: 4000
      });
    }
  });
  
  // Function to show alternative suggestions when booking fails
  async function showAlternativeSuggestions(originalCheckin, originalCheckout) {
    try {
      const response = await fetch(`/api/room/${roomId}/suggested-dates?from_date=${originalCheckin}`);
      const data = await response.json();
      
      if (data.success && data.suggestions.length > 0) {
        const suggestions = data.suggestions.slice(0, 3);
        
        let suggestionsHtml = `
          <div class="conflict-error">
            <h6><i class="fas fa-lightbulb me-2"></i>ƒê·ªÅ xu·∫•t th·ªùi gian thay th·∫ø:</h6>
            <p style="margin-bottom: 15px;">D·ª±a tr√™n l·ªãch ƒë·∫∑t hi·ªán t·∫°i, ch√∫ng t√¥i ƒë·ªÅ xu·∫•t:</p>
        `;
        
        suggestions.forEach((suggestion, index) => {
          suggestionsHtml += `
            <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px; border: 1px solid #28a745;">
              <div style="font-weight: bold; color: #28a745;">
                L·ª±a ch·ªçn ${index + 1}: ${formatDate(suggestion.checkin)} ‚Üí ${formatDate(suggestion.checkout)}
              </div>
              <div style="color: #6c757d; font-size: 0.9rem;">
                ${suggestion.nights} ƒë√™m | ${suggestion.type === 'before_booking' ? 'Tr∆∞·ªõc booking kh√°c' : 'Sau c√°c booking hi·ªán t·∫°i'}
              </div>
              <button type="button" 
                      class="btn btn-success btn-sm mt-2" 
                      onclick="applySuggestion('${suggestion.checkin}', '${suggestion.checkout}')">
                Ch·ªçn th·ªùi gian n√†y
              </button>
            </div>
          `;
        });
        
        suggestionsHtml += `
          </div>
          <div style="text-align: center; margin-top: 15px;">
            <button type="button" class="btn btn-outline-primary" onclick="refreshBookingCalendar()">
              <i class="fas fa-refresh me-1"></i>L√†m m·ªõi l·ªãch ƒë·∫∑t
            </button>
          </div>
        `;
        
        const container = document.querySelector('.booking-form');
        const alertDiv = document.createElement('div');
        alertDiv.className = 'conflict-alert';
        alertDiv.innerHTML = suggestionsHtml;
        container.appendChild(alertDiv);
        
        // Scroll to suggestions
        alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
    } catch (error) {
      console.error('Error getting suggestions:', error);
    }
  }
  
  // Global functions for suggestion interactions
  window.applySuggestion = function(checkin, checkout) {
    document.getElementById('checkin').value = checkin;
    document.getElementById('checkout').value = checkout;
    
    // Clear existing alerts
    clearConflictMessages();
    
    // Show success message
    const nights = Math.ceil((new Date(checkout) - new Date(checkin)) / (1000 * 60 * 60 * 24));
    
    Swal.fire({
      icon: 'success',
      title: 'ƒê√£ c·∫≠p nh·∫≠t th·ªùi gian!',
      text: `Th·ªùi gian m·ªõi: ${formatDate(checkin)} ‚Üí ${formatDate(checkout)} (${nights} ƒë√™m)`,
      timer: 2000,
      showConfirmButton: false
    });
    
    // Trigger validation
    document.getElementById('checkin').dispatchEvent(new Event('change'));
    document.getElementById('checkout').dispatchEvent(new Event('change'));
  }
  
  window.refreshBookingCalendar = async function() {
    Swal.fire({
      title: 'ƒêang l√†m m·ªõi...',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });
    
    try {
      await loadConfirmedBookings();
      
      // Clear old calendar and regenerate
      const existingCalendar = document.querySelector('.booking-timeline');
      if (existingCalendar) {
        existingCalendar.remove();
      }
      
      displayBookingCalendar();
      clearConflictMessages();
      
      Swal.close();
      
      Swal.fire({
        icon: 'success',
        title: 'ƒê√£ c·∫≠p nh·∫≠t!',
        text: 'L·ªãch ƒë·∫∑t ph√≤ng ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi.',
        timer: 1500,
        showConfirmButton: false
      });
      
    } catch (error) {
      console.error('Error refreshing calendar:', error);
      
      Swal.close();
      
      Swal.fire({
        icon: 'error',
        title: 'L·ªói',
        text: 'Kh√¥ng th·ªÉ l√†m m·ªõi l·ªãch. Vui l√≤ng th·ª≠ l·∫°i.',
        timer: 2000,
        showConfirmButton: false
      });
    }
  }
  
  // Auto-refresh booking data every 5 minutes
  setInterval(async function() {
    try {
      await loadConfirmedBookings();
      console.log('üìÖ Auto-refreshed booking data');
    } catch (error) {
      console.warn('Auto-refresh failed:', error);
    }
  }, 5 * 60 * 1000); // 5 minutes
  
  // Helper function for date formatting
  function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('vi-VN', {
      weekday: 'short',
      year: 'numeric', 
      month: 'short',
      day: 'numeric'
    });
  }
});

// Enhanced error handling for edge cases
window.addEventListener('beforeunload', function(e) {
  // Clear any pending API requests when user leaves page
  if (window.pendingBookingCheck) {
    window.pendingBookingCheck.abort();
  }
});

// Show booking tips on page load
setTimeout(function() {
  if (!localStorage.getItem('booking_tips_shown')) {
    Swal.fire({
      icon: 'info',
      title: 'M·∫πo ƒë·∫∑t ph√≤ng',
      html: `
        <div style="text-align: left;">
          <p><i class="fas fa-calendar-check text-primary me-2"></i><strong>L·ªãch ƒë·ªè:</strong> Ng√†y ƒë√£ c√≥ kh√°ch ƒë·∫∑t</p>
          <p><i class="fas fa-calendar-plus text-success me-2"></i><strong>L·ªãch xanh:</strong> Ng√†y c√≥ th·ªÉ ƒë·∫∑t</p>
          <p><i class="fas fa-lightbulb text-warning me-2"></i><strong>G·ª£i √Ω:</strong> H·ªá th·ªëng s·∫Ω ƒë·ªÅ xu·∫•t ng√†y ph√π h·ª£p</p>
        </div>
      `,
      confirmButtonText: 'ƒê√£ hi·ªÉu',
      timer: 8000
    });
    
    localStorage.setItem('booking_tips_shown', 'true');
  }
}, 2000);
//--------------------------------

  // üî• FUNCTION KI·ªÇM TRA RANGE C√ì CH·ª®A NG√ÄY ƒê√É ƒê·∫∂T
  function hasBookedDatesInRange(checkinDate, checkoutDate) {
    const startDate = new Date(checkinDate);
    const endDate = new Date(checkoutDate);
    
    // L·∫∑p qua t·ª´ng ng√†y trong range
    for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
      const dateStr = d.toISOString().split('T')[0];
      if (bookedDates.includes(dateStr)) {
        console.log('‚ùå Found booked date in range:', dateStr);
        return true;
      }
    }
    return false;
  }

  // üî• SETUP FORM HANDLERS (CODE C≈®)
  function setupFormHandlers() {
    const form = document.getElementById('bookingForm');
    const checkinInput = document.getElementById("checkin");
    const checkoutInput = document.getElementById("checkout");
    const adultsInput = document.getElementById("adults");
    const childrenInput = document.getElementById("children");

    form.addEventListener("submit", (e) => {
      // Validate required fields
      if (!checkinInput.value || !checkoutInput.value) {
        e.preventDefault();
        Swal.fire({
          icon: 'warning',
          title: 'Thi·∫øu th√¥ng tin',
          text: 'Vui l√≤ng ch·ªçn ng√†y nh·∫≠n v√† ng√†y ƒëi.',
          timer: 2500,
          showConfirmButton: false
        });
        return;
      }

      const adults = parseInt(adultsInput.value) || 1;
      const children = parseInt(childrenInput.value) || 0;

      // Basic validation
      if (adults < 1) {
        e.preventDefault();
        Swal.fire({
          icon: 'warning',
          title: 'L·ªói nh·∫≠p li·ªáu',
          text: 'S·ªë ng∆∞·ªùi l·ªõn ph·∫£i √≠t nh·∫•t l√† 1.',
          timer: 2500,
          showConfirmButton: false
        });
        return;
      }

      if (adults + children > 15) {
        e.preventDefault();
        Swal.fire({
          icon: 'warning',
          title: 'Qu√° s·ªë l∆∞·ª£ng',
          text: 'T·ªïng s·ªë kh√°ch kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 15 ng∆∞·ªùi.',
          timer: 2500,
          showConfirmButton: false
        });
        return;
      }

      // üî• KI·ªÇM TRA L·∫†I RANGE TR∆Ø·ªöC KHI SUBMIT
      if (hasBookedDatesInRange(checkinInput.value, checkoutInput.value)) {
        e.preventDefault();
        Swal.fire({
          icon: 'error',
          title: 'Kh√¥ng th·ªÉ ƒë·∫∑t ph√≤ng',
          text: 'Kho·∫£ng th·ªùi gian b·∫°n ch·ªçn c√≥ ng√†y ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t. Vui l√≤ng ch·ªçn l·∫°i.',
          timer: 4000,
          showConfirmButton: false
        });
        return;
      }

      // Set hidden values
      document.getElementById("hiddenCheckin").value = checkinInput.value;
      document.getElementById("hiddenCheckout").value = checkoutInput.value;
      document.getElementById("hiddenAdults").value = adults;
      document.getElementById("hiddenChildren").value = children;

      console.log("Booking data being sent:", {
        room_id: roomId,
        checkin: checkinInput.value,
        checkout: checkoutInput.value,
        adults: adults,
        children: children
      });
    });
  }

  // ---- CODE C≈® CHO REVIEW SYSTEM (GI·ªÆ NGUY√äN) ----

  // X·ª≠ l√Ω ch·ªçn sao
  const stars = document.querySelectorAll('#starRating i');
  let selectedRating = 0;

  stars.forEach(star => {
    star.addEventListener('click', () => {
      selectedRating = parseInt(star.getAttribute('data-value'));
      updateStars();
    });

    star.addEventListener('mouseover', () => {
      const value = parseInt(star.getAttribute('data-value'));
      highlightStars(value);
    });
  });

  document.getElementById('starRating').addEventListener('mouseleave', () => {
    updateStars();
  });

  function updateStars() {
    stars.forEach((star, index) => {
      if (index < selectedRating) {
        star.style.color = '#ffc107';
      } else {
        star.style.color = '#ddd';
      }
    });
  }

  function highlightStars(rating) {
    stars.forEach((star, index) => {
      if (index < rating) {
        star.style.color = '#ffc107';
      } else {
        star.style.color = '#ddd';
      }
    });
  }

  // X·ª≠ l√Ω submit form review
  const reviewForm = document.getElementById('reviewForm');
  reviewForm.addEventListener('submit', function (e) {
    e.preventDefault();

    const comment = document.getElementById('commentBox').value.trim();

    if (selectedRating === 0) {
      Swal.fire({
        icon: 'info',
        text: 'Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°.',
        timer: 2000,
        showConfirmButton: false
      });
      return;
    }

    if (!comment) {
      Swal.fire({
        icon: 'info',
        text: 'Vui l√≤ng nh·∫≠p b√¨nh lu·∫≠n.',
        timer: 2000,
        showConfirmButton: false
      });
      return;
    }

    const roomTypeId = reviewForm.getAttribute('data-room-id');

    if (!roomTypeId) {
      Swal.fire({
        icon: 'info',
        text: 'Kh√¥ng t√¨m th·∫•y th√¥ng tin ph√≤ng.',
        timer: 2000,
        showConfirmButton: false
      });
      return;
    }

    const data = {
      rating: selectedRating,
      comment: comment,
      room_type_id: roomTypeId
    };

    console.log('Sending data:', data);

    const submitBtn = reviewForm.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'ƒêang g·ª≠i...';

    fetch('/api/review', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data),
      credentials: 'include'
    })
      .then(res => {
        if (res.status === 401) {
          Swal.fire({
            icon: 'info',
            title: 'B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p',
            text: 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i ƒë√°nh gi√°.',
            confirmButtonText: 'ƒêƒÉng nh·∫≠p'
          }).then(() => {
            window.location.href = '/login';
          });
          throw new Error('Unauthorized - C·∫ßn ƒëƒÉng nh·∫≠p');
        }

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(result => {
        console.log('Response:', result);
        if (result.success) {
          Swal.fire({
            icon: 'success',
            text: 'G·ª≠i ƒë√°nh gi√° th√†nh c√¥ng.',
            timer: 2000,
            showConfirmButton: false
          });
          addReviewToList(result.review);
          resetForm();
        } else {
          Swal.fire({
            icon: 'warning',
            title: 'Error',
            text: 'G·ª≠i ƒë√°nh gi√° th·∫•t b·∫°i.',
            timer: 2000,
            showConfirmButton: false
          });
        }
      })
      .catch(err => {
        console.error('Error:', err);

        if (err.message.includes('Unauthorized')) {
          return;
        }

        if (err.message.includes('status: 400')) {
          Swal.fire({
            icon: 'warning',
            title: 'Error',
            text: 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin ƒë√°nh gi√°.',
            timer: 2000,
            showConfirmButton: false
          });
        } else if (err.message.includes('status: 500')) {
          Swal.fire({
            icon: 'warning',
            title: 'Error',
            text: 'C√≥ l·ªói x·∫£y ra t·ª´ ph√≠a m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          Swal.fire({
            icon: 'warning',
            title: 'Error',
            text: 'C√≥ l·ªói x·∫£y ra khi g·ª≠i ƒë√°nh gi√°. Vui l√≤ng th·ª≠ l·∫°i sau.',
            timer: 2000,
            showConfirmButton: false
          });
        }
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'G·ª≠i ƒë√°nh gi√°';
      });
  });

  function resetForm() {
    reviewForm.reset();
    selectedRating = 0;
    updateStars();
  }

  function addReviewToList(review) {
    const reviewList = document.getElementById('reviewList');
    const reviewHTML = `
      <div style="border-top: 1px solid #dee2e6; padding-top: 15px; margin-top: 15px;">
          <div class="d-flex align-items-center mb-2">
              <img src="https://i.postimg.cc/N0kXMjb5/avatarreview.jpg" 
                   class="rounded-circle me-2" width="40" height="40" />
              <strong>${review.name || '·∫®n danh'}</strong>
          </div>
          <div class="mb-1" style="color: #ffc107;">
              ${renderStars(review.rating)}
          </div>
          <p class="mb-1">${review.comment}</p>
          <small class="text-muted">ƒêƒÉng ng√†y: ${new Date().toLocaleDateString('vi-VN')}</small>
      </div>
  `;
    reviewList.insertAdjacentHTML('afterbegin', reviewHTML);
  }

  function renderStars(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
      stars += i <= rating
        ? '<i class="fas fa-star"></i>'
        : '<i class="far fa-star"></i>';
    }
    return stars;
  }
</script>


<script>
// Thay th·∫ø script validation hi·ªán t·∫°i b·∫±ng code n√†y
document.addEventListener('DOMContentLoaded', function() {
  const maxAdults = <%= room.max_adults %>;
  const maxChildren = <%= room.max_children %>;
  const maxGuests = <%= room.max_guests %>;
  
  const adultsInput = document.getElementById('adults');
  const childrenInput = document.getElementById('children');
  const checkinInput = document.getElementById('checkin');
  const checkoutInput = document.getElementById('checkout');
  
  // T·∫°o element hi·ªÉn th·ªã th√¥ng b√°o l·ªói
  function createErrorMessage(inputElement, message) {
    // X√≥a th√¥ng b√°o l·ªói c≈© n·∫øu c√≥
    const existingError = inputElement.parentNode.querySelector('.error-message');
    if (existingError) {
      existingError.remove();
    }
    
    // T·∫°o th√¥ng b√°o l·ªói m·ªõi
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.style.cssText = `
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 5px;
      padding: 5px;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
      display: flex;
      align-items: center;
    `;
    errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
    
    inputElement.parentNode.appendChild(errorDiv);
    
    // Disable c√°c input kh√°c
    disableOtherInputs();
    
    // Auto remove sau 5 gi√¢y
    setTimeout(() => {
      if (errorDiv && errorDiv.parentNode) {
        errorDiv.remove();
        checkAllValidation();
      }
    }, 5000);
  }
  
  // X√≥a th√¥ng b√°o l·ªói
  function removeErrorMessage(inputElement) {
    const errorDiv = inputElement.parentNode.querySelector('.error-message');
    if (errorDiv) {
      errorDiv.remove();
    }
  }
  
  // Disable/Enable c√°c input kh√°c
  function disableOtherInputs() {
    const hasError = document.querySelectorAll('.error-message').length > 0;
    checkinInput.disabled = hasError;
    checkoutInput.disabled = hasError;
    
    if (hasError) {
      checkinInput.style.backgroundColor = '#f8f9fa';
      checkoutInput.style.backgroundColor = '#f8f9fa';
    } else {
      checkinInput.style.backgroundColor = '';
      checkoutInput.style.backgroundColor = '';
    }
  }
  
  // Ki·ªÉm tra t·∫•t c·∫£ validation
  function checkAllValidation() {
    const adults = parseInt(adultsInput.value) || 0;
    const children = parseInt(childrenInput.value) || 0;
    
    // Reset t·∫•t c·∫£ error messages
    removeErrorMessage(adultsInput);
    removeErrorMessage(childrenInput);
    
    let hasError = false;
    
    // Validate adults
    if (adults > maxAdults) {
      createErrorMessage(adultsInput, `S·ªë ng∆∞·ªùi l·ªõn t·ªëi ƒëa l√† ${maxAdults} ng∆∞·ªùi. Vui l√≤ng nh·∫≠p l·∫°i!`);
      adultsInput.focus();
      hasError = true;
    } else if (adults < 1) {
      createErrorMessage(adultsInput, 'C·∫ßn √≠t nh·∫•t 1 ng∆∞·ªùi l·ªõn!');
      adultsInput.focus();
      hasError = true;
    }
    
    // Validate children
    if (children > maxChildren) {
      createErrorMessage(childrenInput, `S·ªë tr·∫ª em t·ªëi ƒëa l√† ${maxChildren} em. Vui l√≤ng nh·∫≠p l·∫°i!`);
      if (!hasError) childrenInput.focus();
      hasError = true;
    }
    
    // Validate total guests
    if (!hasError && (adults + children) > maxGuests) {
      createErrorMessage(childrenInput, `T·ªïng s·ªë kh√°ch t·ªëi ƒëa l√† ${maxGuests} ng∆∞·ªùi (${adults + children} > ${maxGuests}). Vui l√≤ng gi·∫£m s·ªë l∆∞·ª£ng!`);
      childrenInput.focus();
      hasError = true;
    }
    
    disableOtherInputs();
    
    return !hasError;
  }
  
  // Event listeners cho real-time validation
  adultsInput.addEventListener('input', function() {
    // Delay validation m·ªôt ch√∫t ƒë·ªÉ user c√≥ th·ªÉ g√µ s·ªë
    setTimeout(checkAllValidation, 300);
  });
  
  adultsInput.addEventListener('blur', function() {
    checkAllValidation();
  });
  
  childrenInput.addEventListener('input', function() {
    setTimeout(checkAllValidation, 300);
  });
  
  childrenInput.addEventListener('blur', function() {
    checkAllValidation();
  });
  
  // Validation khi submit form
  const bookingForm = document.getElementById('bookingForm');
  bookingForm.addEventListener('submit', function(e) {
    if (!checkAllValidation()) {
      e.preventDefault();
      Swal.fire({
        icon: 'error',
        title: 'Th√¥ng tin kh√¥ng h·ª£p l·ªá',
        text: 'Vui l√≤ng ki·ªÉm tra l·∫°i s·ªë l∆∞·ª£ng kh√°ch tr∆∞·ªõc khi ƒë·∫∑t ph√≤ng.',
        timer: 3000,
        showConfirmButton: false
      });
      return false;
    }
    
    const checkin = checkinInput.value;
    const checkout = checkoutInput.value;
    
    if (!checkin || !checkout) {
      e.preventDefault();
      Swal.fire({
        icon: 'warning',
        title: 'Thi·∫øu th√¥ng tin',
        text: 'Vui l√≤ng ch·ªçn ng√†y nh·∫≠n v√† ng√†y ƒëi.',
        timer: 2500,
        showConfirmButton: false
      });
      return false;
    }
    
    // G√°n gi√° tr·ªã v√†o hidden inputs
    const adults = parseInt(adultsInput.value) || 1;
    const children = parseInt(childrenInput.value) || 0;
    
    document.getElementById('hiddenAdults').value = adults;
    document.getElementById('hiddenChildren').value = children;
    document.getElementById('hiddenCheckin').value = checkin;
    document.getElementById('hiddenCheckout').value = checkout;
    
    console.log("Booking data:", {
      room_id: '<%= room.room_type_id %>',
      adults: adults,
      children: children,
      checkin: checkin,
      checkout: checkout
    });
  });
  
  // Initial validation khi trang load
  setTimeout(checkAllValidation, 500);
});
</script>

  <!-- ----------------------------------- -->
</body>

</html>